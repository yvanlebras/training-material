<!DOCTYPE html>
<html>











  <head>
    <meta charset="utf-8">
    <title>Galactic Database</title>
    
        <script async defer data-domain="training.galaxyproject.org" src="https://plausible.galaxyproject.eu/js/plausible.js"></script>

    
    <link rel="stylesheet" href="/training-material/assets/css/slides.css">
    <script src="https://kit.fontawesome.com/67b3f98409.js" crossorigin="anonymous"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="shortcut icon" href="/training-material/favicon.ico" type="image/x-icon" />

    
    
    
    
    <meta name="description" content="Resources related to configuration and maintenance of Gal..." />
    <meta property="og:title" content="Galaxy Training: Galactic Database" />
    <meta property="og:description" content="Resources related to configuration and maintenance of Gal..." />
    <meta property="og:image" content="/training-material/assets/images/GTNLogo1000.png" />
    <script type="application/ld+json">
      


{
  "@context": "http://schema.org",
  "@type": "Course",
  "accessMode": [
    "textual",
    "visual"
  ],
  "accessModeSufficient": [
    "textual",
    "visual"
  ],
  "accessibilityControl": [
    "fullKeyboardControl",
    "fullMouseControl"
  ],
  "accessibilityFeature": [
    "alternativeText",
    "tableOfContents"
  ],
  "accessibilitySummary": "Short descriptions are present but long descriptions will be needed for non-visual users",
  "audience": {
    "@type": "EducationalAudience",
    "educationalRole": "students"
  },
  "citation": {
    "@type": "CreativeWork",
    "name": "Community-Driven Data Analysis Training for Biology",
    "url": "https://doi.org/10.1016/j.cels.2018.05.012"
  },
  "copyrightHolder": {
    "@type": "Organization",
    "email": "galaxytrainingnetwork@gmail.com",
    "name": "Galaxy Training Network",
    "url": "https://galaxyproject.org/teach/gtn/"
  },
  "dateModified": "1970-01-01 00:33:41 +0000",
  "discussionUrl": "https://gitter.im/Galaxy-Training-Network/Lobby",
  "headline": "Galactic Database",
  "interactivityType": "mixed",
  "isAccessibleForFree": true,
  "isFamilyFriendly": true,
  "license": "https://spdx.org/licenses/CC-BY-4.0.html",
  "producer": {
    "@type": "Organization",
    "email": "galaxytrainingnetwork@gmail.com",
    "name": "Galaxy Training Network",
    "url": "https://galaxyproject.org/teach/gtn/"
  },
  "provider": {
    "@type": "Organization",
    "email": "galaxytrainingnetwork@gmail.com",
    "name": "Galaxy Training Network",
    "url": "https://galaxyproject.org/teach/gtn/"
  },
  "sourceOrganization": {
    "@type": "Organization",
    "email": "galaxytrainingnetwork@gmail.com",
    "name": "Galaxy Training Network",
    "url": "https://galaxyproject.org/teach/gtn/"
  },
  "isPartOf": {
    "@type": "CreativeWork",
    "name": "Galaxy Server administration",
    "description": "Resources related to configuration and maintenance of Galaxy servers",
    "url": "https://training.galaxyproject.org//training-material/topics/admin/"
  },
  "courseCode": "admin / database / slides",
  "learningResourceType": "slides",
  "name": "Slides for 'Galactic Database' tutorial",
  "url": "https://training.galaxyproject.org//training-material/topics/admin/tutorials/database/slides.html",
  "description": "",
  "inLanguage": {
    "@type": "Language",
    "name": "English",
    "alternateName": "en"
  },
  "hasPart": [

  ],
  "author": [
    {
      "@type": "Person",
      "name": "Martin Čech"
    },
    {
      "@type": "Person",
      "name": "Nicola Soranzo"
    },
    {
      "@type": "Person",
      "name": "Nate Coraor"
    },
    {
      "@type": "Person",
      "name": "Helena Rasche"
    }
  ],
  "contributor": [
    {
      "@type": "Person",
      "name": "Martin Čech"
    },
    {
      "@type": "Person",
      "name": "Nicola Soranzo"
    },
    {
      "@type": "Person",
      "name": "Nate Coraor"
    },
    {
      "@type": "Person",
      "name": "Helena Rasche"
    }
  ],
  "about": [
    {
      "@type": "CreativeWork",
      "name": "Galaxy Server administration",
      "description": "Resources related to configuration and maintenance of Galaxy servers",
      "url": "https://training.galaxyproject.org//training-material/topics/admin/"
    }
  ]
}
    </script>
    <script type="text/javascript" src="/training-material/assets/js/jquery.slim.min.js"></script>
  </head>
  <body>
    <textarea id="source">
name: inverse
layout: true
class: center, middle, inverse

<div class="my-header"><span>
<a href="/training-material/topics/admin" title="Return to topic page" ><i class="fa fa-level-up" aria-hidden="true"></i></a>

<a class="nav-link" href="https://github.com/galaxyproject/training-material/edit/main/topics/admin/tutorials/database/slides.html"><i class="fa fa-pencil" aria-hidden="true"></i></a>

</span></div>

<div class="my-footer"><span>

  
<img src="/training-material/assets/images/gat.png" alt="page logo" style="height: 40px;"/>
  

</span></div>

---



  
<img src="/training-material/assets/images/gat.png" alt="page logo" class="cover-logo" />
  


# Galactic Database


<div class="contributors-line">

<a href="/training-material/hall-of-fame/martenson/" class="contributor-badge contributor-martenson"><img src="https://avatars.githubusercontent.com/martenson?s=27" alt="Avatar">Martin Čech</a>


<a href="/training-material/hall-of-fame/nsoranzo/" class="contributor-badge contributor-nsoranzo"><img src="https://avatars.githubusercontent.com/nsoranzo?s=27" alt="Avatar">Nicola Soranzo</a>


<a href="/training-material/hall-of-fame/natefoo/" class="contributor-badge contributor-natefoo"><img src="https://avatars.githubusercontent.com/natefoo?s=27" alt="Avatar">Nate Coraor</a>


<a href="/training-material/hall-of-fame/hexylena/" class="contributor-badge contributor-hexylena"><img src="https://avatars.githubusercontent.com/hexylena?s=27" alt="Avatar">Helena Rasche</a>


<a href="https://training.galaxyproject.org/training-material/topics/contributing/" class="contributor-badge contributor-newcontributors"><i class="fas fa-users" aria-hidden="true"></i><span class="visually-hidden">hall-of-fame</span>Add Contributions!</a>


</div>


<div class="footnote" style="bottom: 5.5em;"><i class="far fa-calendar" aria-hidden="true"></i><span class="visually-hidden">last_modification</span> Updated: Apr 6, 2021</div>

<div class="footnote" style="bottom: 4em;"><a href="/training-material/videos/watch.html?v=/admin/tutorials/database/slides"><i class="far fa-play-circle" aria-hidden="true"></i><span class="visually-hidden">video-slides</span> View video slides for this lecture</a></div>

<div class="footnote" style="bottom: 2.5em;"><i class="fas fa-file-alt" aria-hidden="true"></i><span class="visually-hidden">text-document</span><a href="slides-plain.html"> Plain-text slides</a></div>
<div class="footnote" style="bottom: 1em;"><strong>Tip: </strong>press <kbd>P</kbd> to view the presenter notes</div>

???
Presenter notes contain extra information which might be useful if you intend to use these slides for teaching.

Press `P` again to switch presenter notes off

Press `C` to create a new window where the same presentation will be displayed.
This window is linked to the main window. Changing slides on one will cause the
slide to change on the other.

Useful when presenting.



---










# Galactic Database

.left[Galaxy uses a database for:]
* Galaxy objects and all their relations (users, histories, datasets, workflows)
* Job state persistence, job dispatching

.left[Galaxy does not use a database for:]
* Dataset **contents**: files on disk

???

- Galaxy objects like users, histories, datasets, and workflows are stored in the database.
- All job information is likewise stored there.
- User and reference data, however, are stored outside of the database.
- You will want to backup both user data and your database.

---

# Defaults

* Galaxy uses the [SQLAlchemy](http://www.sqlalchemy.org/) database abstraction layer. This allows for different database servers to be plugged in.
* By default Galaxy automatically creates and uses an [SQLite](https://sqlite.org/) database during the first startup.
  * The database is in the file `database/universe.sqlite`

???

- Galaxy uses SQLAlchemy for interacting with databases.
- This allows Galaxy to transparently use sqlite or postgres.

---
# Choices

* SQLite
  * Useful for single-user Galaxy or development.
* **PostgreSQL**
  * The recommended standard for anything serious.
* ~~MySQL~~
  * Supported by SQLAlchemy but Galaxy is not tested against it.

???

- sqlite is fine in development, but should not be used for production.
- postgres is the best for any production server.
- Do not use mysql if possible.

---
# Sizing

Galaxy rarely deletes from the database, most objects are *marked* deleted.

Allocate at least 20 GB of disk to start, 50+ GB if expanding would be difficult.

8-16 GB memory should be sufficient.

Recommended: Run PostgreSQL on a different server for resource isolation.

???

- Data is not removed from the database, so plan accordingly.
- Allocated at least 20 GB of disk to start, and 50 if expanding later is difficult.
- The RAM usage is usually not significant.
- We recommend running the database on a separate server from Galaxy for better isolation.

---
# Configuration

`database_connection` is specified as a [database URL](http://docs.sqlalchemy.org/en/latest/core/engines.html#database-urls) in `galaxy.yml`
  * Default SQLite:
      `sqlite:///./database/universe.sqlite?isolation_level=IMMEDIATE`

  * Local PostgreSQL (socket):
       `postgresql:///&lt;db_name&gt;[?host=/var/run/postgresql]`

  * Network PostgreSQL:
      `postgresql://[user][:password]@&lt;host&gt;[:5432]/&lt;db_name&gt;`

???

- The parameter database_connection tells galaxy where the database is.
- There are several styles, depending on how you connect to your database.

---
# New Database

On first startup with an empty database, Galaxy creates its schema

???

- On first startup with an empty database, Galaxy creates its schema.

---
# Migrations

Changes in the Galaxy DB model (when upgrading Galaxy) are captured incrementally in the form of [atomic scripts](https://github.com/galaxyproject/galaxy/tree/dev/lib/galaxy/model/migrate/versions).

Each script can both upgrade and downgrade a DB.

```console
$ ./manage_db.sh upgrade
$ ./manage_db.sh downgrade --version=132
```

???

- Whenever Galaxy is upgraded, there may be changes to the database schema.
- These are stored in migration scripts, and you can use the manage db script to up or downgrade.

---
# Tuning - Pool

If the server logs errors about not having enough database pool connections.

| Galaxy config option                  | default value | usegalaxy.org value |
| ------                                | ------------- | ------------------- |
| `database_engine_option_pool_size`    | `5`           | `10`                |
| `database_engine_option_max_overflow` | `10`          | `20`                |

[Values for usegalaxy.org](https://github.com/galaxyproject/usegalaxy-playbook/blob/master/env/main/group_vars/all/galaxy_config_vars.yml)

???

- Databases have a limited number of connection slots.
- Galaxy can pool connections, and re-use existing connections from a pool when it needs to query the DB.
- There are a couple of options for controlling pooling.
- The defaults are generally fine until you see errors.

---
# Tuning - Server-side cursors

If large database query results are causing memory or response time issues in the Galaxy process, leave it on server
(PostgreSQL only, recommended).

| Galaxy config option                         | default value | usegalaxy.org value |
| ------                                       | ------------- | ------------------- |
| `database_engine_option_server_side_cursors` | `false`       | `true`              |

???

- Large queries may slow down Galaxy or the DB.
- You can enable server side cursors to help with this.

---
# Tuning - Slow query logging

Queries slower than this threshold (in s) will be logged at debug level.

| Galaxy config option       | default value | usegalaxy.org value |
| ------                     | ------------- | ------------------- |
| `slow_query_log_threshold` | `0`           | `2`                 |

???

- If you notice slow responses, you can enable slow query logging.
- This will print a message in your Galaxy log if a query takes more than a specified time period.
- This can be useful to help you debug issues.

---
# Tuning - TS install database

Galaxy can track Tool Shed data in a separate DB.

| Galaxy config option          | default value                  | usegalaxy.org value |
| ------                        | -------------                  | ------------------- |
| `install_database_connection` | value of `database_connection` | SQLite DB in CVMFS  |

All other database config options but prefixed with `install_` are also available.

.left[This allows:]
* Bootstrapping fresh Galaxy instances with prebuilt/tested tool sets
* Atomic installation/rollback (esp. with SQLite: backup and restore DB file)

???

- Galaxy can track tool shed data in a separate database
- This can enable deploying Galaxies with prebuilt tool sets

---
# Access through model

Python script to access Galaxy's database layer **via the Galaxy model**.

```console
(venv)$ python -i scripts/db_shell.py
&gt;&gt;&gt; new_user = User('foo@example.org', 'secret')
&gt;&gt;&gt; new_user.username = 'foo'
&gt;&gt;&gt; sa_session.add(new_user)
&gt;&gt;&gt; sa_session.flush()
&gt;&gt;&gt; sa_session.query(User).all()
```

???

- You can use the Galaxy python models to interact with the database.
- After activating the galaxy virtual environment, you can use the DB shell script to interface.
- This can allow scripting tasks like resetting passwords.

---
# Useful queries

Captured in [gxadmin](/training-material/topics/admin/tutorials/gxadmin/slides.html) ([tutorial](/training-material/topics/admin/tutorials/gxadmin/tutorial.html))

???

- Many useful DB queries are captured in gxadmin
- Look into this if you need to query the database for information like running jobs or recent users.









---

## Thank You!

This material is the result of a collaborative work. Thanks to the [Galaxy Training Network](https://training.galaxyproject.org) and all the contributors!


<div class="contributors-line">

<a href="/training-material/hall-of-fame/martenson/" class="contributor-badge contributor-martenson"><img src="https://avatars.githubusercontent.com/martenson?s=27" alt="Avatar">Martin Čech</a>


<a href="/training-material/hall-of-fame/nsoranzo/" class="contributor-badge contributor-nsoranzo"><img src="https://avatars.githubusercontent.com/nsoranzo?s=27" alt="Avatar">Nicola Soranzo</a>


<a href="/training-material/hall-of-fame/natefoo/" class="contributor-badge contributor-natefoo"><img src="https://avatars.githubusercontent.com/natefoo?s=27" alt="Avatar">Nate Coraor</a>


<a href="/training-material/hall-of-fame/hexylena/" class="contributor-badge contributor-hexylena"><img src="https://avatars.githubusercontent.com/hexylena?s=27" alt="Avatar">Helena Rasche</a>


</div>



  
<img src="/training-material/assets/images/gat.png" alt="page logo" style="height: 100px;"/>
  


<a rel="license" href="https://creativecommons.org/licenses/by/4.0/">
This material is licensed under the Creative Commons Attribution 4.0 International License</a>.


    </textarea>
	<script src="/training-material/assets/js/remark-latest.min.js" type="text/javascript"></script>
    <script type="text/javascript" src="/training-material/assets/js/theme.js"></script>
    <script type="text/javascript" src="/training-material/assets/js/clipboard.min.js"></script>
    <script type="text/javascript">
      var slideshow = remark.create({navigation: {scroll: false}, ratio: '16:9'});
      var hljs = remark.highlighter.engine;
      var snippets = document.querySelectorAll('code.remark-code');
        [].forEach.call(snippets,function(snippet){
          snippet.firstChild.insertAdjacentHTML('beforebegin','<button class="btn btn-light" data-clipboard-snippet><i class="fa fa-copy"></i>&nbsp;Copy</button>');
        });
      var clipboardSnippets=new ClipboardJS('[data-clipboard-snippet]',{
        target:function(trigger){return trigger.parentElement;
      }});
    </script>

    <script type="text/javascript">
        if(window.location.hostname === "galaxyproject.github.io") {
            // Redirect
            var redirect = "https://training.galaxyproject.org" + window.location.pathname + window.location.search;
            $('body').prepend("<div style='text-align: center'><strong>Note: </strong>This content has a new home at <a href=\"" + redirect + "\">" + redirect + "</a>, which you will be redirected to in 5 seconds.</div>");

            window.setTimeout(function(){
                window.location.href = redirect;
            }, 5000)

        }
    </script>

  </body>
</html>
