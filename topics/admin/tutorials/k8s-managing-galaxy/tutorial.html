<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <title>Managing Galaxy on Kubernetes</title>
        
            <script async defer data-domain="training.galaxyproject.org" src="https://plausible.galaxyproject.eu/js/plausible.js"></script>

        
        <link rel="stylesheet" href="/training-material/assets/css/bootstrap.min.css?v=3">
        <link rel="stylesheet" href="/training-material/assets/css/bootstrap-toc.min.css">
        <link rel="stylesheet" href="/training-material/assets/css/main.css?v=2">
        <script src="https://kit.fontawesome.com/67b3f98409.js" crossorigin="anonymous"></script>
        <link rel="stylesheet" href="/training-material/assets/css/academicons.css">
        <link rel="stylesheet" href="/training-material/assets/css/syntax_highlighting.css">
        <link rel="shortcut icon" href="/training-material/favicon.ico" type="image/x-icon" />
        <link rel="alternate" type="application/atom+xml" href="/training-material/feed.xml" />

        
        
        
        
        
        <meta name="description" content="Resources related to configuration and maintenance of Gal..." />
        <meta property="og:title" content="Galaxy Training: Managing Galaxy on Kubernetes" />
        <meta property="og:description" content="Resources related to configuration and maintenance of Gal..." />
        <meta property="og:image" content="/training-material/assets/images/GTNLogo1000.png" />
    </head>
    <body data-spy="scroll" data-target="#toc">
        <header>
    <nav class="navbar navbar-expand-md navbar-dark" aria-label="Site Navigation">
        <div class="container">
            <a class="navbar-brand" href="/training-material/">
                <img src="/training-material/assets/images/GTN-60px.png" height="30" alt="Galaxy Training Network logo">
                Galaxy Training!
            </a>

            <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#top-navbar" aria-controls="top-navbar" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="top-navbar">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        
                        <a class="nav-link" href="/training-material/topics/admin" title="Go back to list of tutorials">
                            <i class="far fa-folder" aria-hidden="true"></i> Galaxy Server administration
                        </a>
                        
                    </li>

                    <li class="nav-item dropdown">
                        <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown" aria-expanded="false" title="Languages">
                            <i class="fas fa-language" aria-hidden="true"></i><span class="visually-hidden">language</span> Languages
                        </a>
                        <div class="dropdown-menu dropdown-menu-right">
                            
                              <strong class="dropdown-header">Automatic Translations</strong>
            
            <a class="dropdown-item" href="https://translate.google.com/translate?hl=jp&sl=en&tl=fr&u=https%3A%2F%2Ftraining.galaxyproject.org/topics/admin/tutorials/k8s-managing-galaxy/tutorial.html&edit-text=&act=url">
                            Français
                            </a>
                            
            <a class="dropdown-item" href="https://translate.google.com/translate?hl=jp&sl=en&tl=ja&u=https%3A%2F%2Ftraining.galaxyproject.org/topics/admin/tutorials/k8s-managing-galaxy/tutorial.html&edit-text=&act=url">
                            日本語
                            </a>
                            
            <a class="dropdown-item" href="https://translate.google.com/translate?hl=jp&sl=en&tl=es&u=https%3A%2F%2Ftraining.galaxyproject.org/topics/admin/tutorials/k8s-managing-galaxy/tutorial.html&edit-text=&act=url">
                            Español
                            </a>
                            
            <a class="dropdown-item" href="https://translate.google.com/translate?hl=jp&sl=en&tl=pt&u=https%3A%2F%2Ftraining.galaxyproject.org/topics/admin/tutorials/k8s-managing-galaxy/tutorial.html&edit-text=&act=url">
                            Português
                            </a>
                            
            <a class="dropdown-item" href="https://translate.google.com/translate?hl=jp&sl=en&tl=ar&u=https%3A%2F%2Ftraining.galaxyproject.org/topics/admin/tutorials/k8s-managing-galaxy/tutorial.html&edit-text=&act=url">
                            العربية
                            </a>
                            
                            <a class="dropdown-item" href="https://translate.google.com/translate?hl=jp&sl=en&tl=&u=https%3A%2F%2Ftraining.galaxyproject.org/topics/admin/tutorials/k8s-managing-galaxy/tutorial.html&edit-text=&act=url" title="">
                            And more!
                            </a>
                        </div>
                    </li>

                    <li class="nav-item dropdown">
    <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown" aria-expanded="false" title="Help">
        <i class="far fa-question-circle" aria-hidden="true"></i><span class="visually-hidden">help</span> Help
    </a>
    <div class="dropdown-menu dropdown-menu-right">
        <!-- disable Tess for now
        <form method="get" action="https://tess.elixir-europe.org/materials">
            <input type="text" id="search" name="q" value="" style="margin-left: 0.5em;/*! border-radius: 0px; */">
            <input type="hidden" value="Galaxy Training" name="content_provider">
            <input type="submit" value="Search on TeSS" style="width: 92%;border-radius: 0px;margin: 0.5em;background: #f47d20;border: 0px;padding: 0.25em;" class="">
        </form>
        -->

        <a class="dropdown-item" href="/training-material/faq" title="Check our FAQs">
           <i class="far fa-question-circle" aria-hidden="true"></i><span class="visually-hidden">question</span> FAQs
        </a>
        
        <a class="dropdown-item" href="/training-material/topics/admin/faqs/" title="Check our FAQs for the Galaxy Server administration topic">
           <i class="far fa-question-circle" aria-hidden="true"></i><span class="visually-hidden">question</span> Topic FAQs
        </a>
        
        <a class="dropdown-item" href="https://help.galaxyproject.org/" title="Discuss on Galaxy Help">
            <i class="far fa-comments" aria-hidden="true"></i><span class="visually-hidden">feedback</span> Galaxy Help Forum
        </a>
        <a class="dropdown-item" href="https://gitter.im/Galaxy-Training-Network/Lobby" title="Discuss on gitter">
           <i class="fab fa-gitter" aria-hidden="true"></i><span class="visually-hidden">gitter</span> Discuss on Gitter
        </a>
    </div>
</li>


                    <li class="nav-item dropdown">
    <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown" aria-expanded="false" title="Extras">
        <i class="far fa-star" aria-hidden="true"></i><span class="visually-hidden">galaxy-star</span> Extras
    </a>
    <div class="dropdown-menu dropdown-menu-right">

        
        <a class="dropdown-item" href="https://github.com/galaxyproject/training-material/edit/main/topics/admin/tutorials/k8s-managing-galaxy/tutorial.md" title="Edit on GitHub">
          <i class="fab fa-github" aria-hidden="true"></i><span class="visually-hidden">github</span> Edit on GitHub
        </a>

        <a class="dropdown-item" href="/training-material/stats.html" title="Show view statistics about this repository">
            <i class="fas fa-chart-bar" aria-hidden="true"></i><span class="visually-hidden">galaxy-barchart</span> GTN statistics
        </a>

        <a class="dropdown-item" href="https://plausible.galaxyproject.eu/training.galaxyproject.org?period=12mo&page=/training-material/topics/admin/tutorials/k8s-managing-galaxy/tutorial.html" title="Show view statistics of this page">
            <i class="fas fa-chart-bar" aria-hidden="true"></i><span class="visually-hidden">galaxy-barchart</span> Page Metrics
        </a>

        
            <a class="dropdown-item" href="/training-material/feedback.html" title="Show feedback statistics about this repository">
                <i class="fas fa-chart-bar" aria-hidden="true"></i><span class="visually-hidden">galaxy-barchart</span> GTN feedback
            </a>
        

        <div class="dropdown-item">
            <div>
                <i class="fas fa-palette" aria-hidden="true"></i><span class="visually-hidden">gtn-theme</span> Theme
            </div>

            <div id="theme-selector" data-toggle="buttons">
                <label data-value="default" class="btn btn-secondary">
                    <input type="radio" name="options" id="default" autocomplete="off"> Default
                </label>
                <label data-value="night" class="btn btn-secondary">
                    <input type="radio" name="options" id="night" autocomplete="off"> Night
                </label>
                <label data-value="midnight" class="btn btn-secondary">
                    <input type="radio" name="options" id="midnight" autocomplete="off"> Midnight
                </label>
                <label data-value="rainbow" class="btn btn-secondary">
                    <input type="radio" name="options" id="rainbow" autocomplete="off"> Rainbow
                </label>
                <label data-value="progress" class="btn btn-secondary">
                    <input type="radio" name="options" id="progress" autocomplete="off">🏳️‍🌈
                </label>
                <label data-value="halloween" class="btn btn-secondary">
                    <input type="radio" name="options" id="halloween" autocomplete="off"> 🎃
                </label>
                <label data-value="straya" class="btn btn-secondary">
                    <input type="radio" name="options" id="downunder" autocomplete="off"> 🇦🇺
                </label>
            </div>

        </div>

        <div class="dropdown-item">
            <div>
                <i class="fas fa-history" aria-hidden="true"></i><span class="visually-hidden">galaxy-rulebuilder-history</span> Previous Versions
            </div>

            
            <div id="archive-selector">
            
                <a class="btn btn-warning" href="https://training.galaxyproject.org/archive/" title="Older Versions">Older Versions</a>
            </div>

        </div>

    </div>
</li>


                    <!-- Search bar-->
                    <li class="nav-item">
                      <div id="navbarSupportedContent" role="search">
                        <!-- Search form -->
                        <form class="form-inline mr-auto" method="GET" action="/training-material/search">
                          <i class="fas fa-search nav-link" aria-hidden="true"></i>
                          <div class="md-form mb-2">
                            <input name="query" class="form-control nicer" type="text" placeholder="Search Tutorials" aria-label="Search">
                          </div>
                        </form>
                      </div>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
</header>

        <div class="container main-content" role="main">
        











<!-- Gitter -->




<script>
  ((window.gitter = {}).chat = {}).options = {
  room: 'galaxyproject/admins'
  };
</script>
<script src="https://sidecar.gitter.im/dist/sidecar.v1.js" async defer></script>

<script type="application/ld+json">
    


{
  "@context": "http://schema.org",
  "@type": "Course",
  "accessMode": [
    "textual",
    "visual"
  ],
  "accessModeSufficient": [
    "textual",
    "visual"
  ],
  "accessibilityControl": [
    "fullKeyboardControl",
    "fullMouseControl"
  ],
  "accessibilityFeature": [
    "alternativeText",
    "tableOfContents"
  ],
  "accessibilitySummary": "Short descriptions are present but long descriptions will be needed for non-visual users",
  "audience": {
    "@type": "EducationalAudience",
    "educationalRole": "students"
  },
  "citation": {
    "@type": "CreativeWork",
    "name": "Community-Driven Data Analysis Training for Biology",
    "url": "https://doi.org/10.1016/j.cels.2018.05.012"
  },
  "copyrightHolder": {
    "@type": "Organization",
    "email": "galaxytrainingnetwork@gmail.com",
    "name": "Galaxy Training Network",
    "url": "https://galaxyproject.org/teach/gtn/"
  },
  "dateModified": "1970-01-01 00:00:06 +0000",
  "discussionUrl": "https://gitter.im/Galaxy-Training-Network/Lobby",
  "headline": "Managing Galaxy on Kubernetes",
  "interactivityType": "mixed",
  "isAccessibleForFree": true,
  "isFamilyFriendly": true,
  "license": "https://spdx.org/licenses/CC-BY-4.0.html",
  "producer": {
    "@type": "Organization",
    "email": "galaxytrainingnetwork@gmail.com",
    "name": "Galaxy Training Network",
    "url": "https://galaxyproject.org/teach/gtn/"
  },
  "provider": {
    "@type": "Organization",
    "email": "galaxytrainingnetwork@gmail.com",
    "name": "Galaxy Training Network",
    "url": "https://galaxyproject.org/teach/gtn/"
  },
  "sourceOrganization": {
    "@type": "Organization",
    "email": "galaxytrainingnetwork@gmail.com",
    "name": "Galaxy Training Network",
    "url": "https://galaxyproject.org/teach/gtn/"
  },
  "isPartOf": {
    "@type": "CreativeWork",
    "name": "Galaxy Server administration",
    "description": "Resources related to configuration and maintenance of Galaxy servers",
    "url": "https://training.galaxyproject.org//training-material/topics/admin/"
  },
  "courseCode": "admin / k8s-managing-galaxy / hands-on",
  "learningResourceType": "hands-on tutorial",
  "name": "Hands-on for 'Managing Galaxy on Kubernetes' tutorial",
  "url": "https://training.galaxyproject.org//training-material/topics/admin/tutorials/k8s-managing-galaxy/tutorial.html",
  "timeRequired": "PT30M",
  "keywords": "kubernetes",
  "description": "The questions this  addresses are:\n - How do I change Galaxy configs?\n - How can I upgrade to a new version?\n - How do I rollback my changes?\n - How do I scale Galaxy?\n\n\\nThe objectives are:\n - Have an understanding of how to modify Galaxy configuration\n - Be able to upgrade and scale galaxy\n\n",
  "inLanguage": {
    "@type": "Language",
    "name": "English",
    "alternateName": "en"
  },
  "coursePrerequisites": [
    {
      "@type": "Course",
      "url": "https://training.galaxyproject.org//training-material/topics/admin/tutorials/k8s-deploying-galaxy/tutorial.html",
      "name": "Galaxy Installation on Kubernetes",
      "description": "Hands-on for 'Galaxy Installation on Kubernetes' tutorial",
      "learningResourceType": "hands-on tutorial",
      "interactivityType": "expositive",
      "provider": {
        "@type": "Organization",
        "email": "galaxytrainingnetwork@gmail.com",
        "name": "Galaxy Training Network",
        "url": "https://galaxyproject.org/teach/gtn/"
      }
    }
  ],
  "hasPart": [

  ],
  "author": [
    {
      "@type": "Person",
      "name": "Nuwan Goonasekera"
    },
    {
      "@type": "Person",
      "name": "Enis Afgan"
    },
    {
      "@type": "Person",
      "name": "Alex Mahmoud"
    },
    {
      "@type": "Person",
      "name": "Pablo Moreno"
    },
    {
      "@type": "Person",
      "name": "Sergey Golitsynskiy"
    }
  ],
  "contributor": [
    {
      "@type": "Person",
      "name": "Nuwan Goonasekera"
    },
    {
      "@type": "Person",
      "name": "Enis Afgan"
    },
    {
      "@type": "Person",
      "name": "Alex Mahmoud"
    },
    {
      "@type": "Person",
      "name": "Pablo Moreno"
    },
    {
      "@type": "Person",
      "name": "Sergey Golitsynskiy"
    }
  ],
  "about": [
    {
      "@type": "CreativeWork",
      "name": "Galaxy Server administration",
      "description": "Resources related to configuration and maintenance of Galaxy servers",
      "url": "https://training.galaxyproject.org//training-material/topics/admin/"
    }
  ],
  "skillLevel": "Intermediate"
}
</script>

<section class="tutorial topic-admin">
    <h1 data-toc-skip>Managing Galaxy on Kubernetes</h1>
    


    <div class="contributors-line">Authors: 
<a href="/training-material/hall-of-fame/nuwang/" class="contributor-badge contributor-nuwang"><img src="https://avatars.githubusercontent.com/nuwang?s=27" alt="Avatar">Nuwan Goonasekera</a>


<a href="/training-material/hall-of-fame/afgane/" class="contributor-badge contributor-afgane"><img src="https://avatars.githubusercontent.com/afgane?s=27" alt="Avatar">Enis Afgan</a>


<a href="/training-material/hall-of-fame/almahmoud/" class="contributor-badge contributor-almahmoud"><img src="https://avatars.githubusercontent.com/almahmoud?s=27" alt="Avatar">Alex Mahmoud</a>


<a href="/training-material/hall-of-fame/pcm32/" class="contributor-badge contributor-pcm32"><img src="https://avatars.githubusercontent.com/pcm32?s=27" alt="Avatar">Pablo Moreno</a>


<a href="/training-material/hall-of-fame/ic4f/" class="contributor-badge contributor-ic4f"><img src="https://avatars.githubusercontent.com/ic4f?s=27" alt="Avatar">Sergey Golitsynskiy</a>


<a href="https://training.galaxyproject.org/training-material/topics/contributing/" class="contributor-badge contributor-newcontributors"><i class="fas fa-users" aria-hidden="true"></i><span class="visually-hidden">hall-of-fame</span>Add Contributions!</a>

</div>


    <blockquote class="overview">
        <h3>Overview</h3>
        
        <img alt="Creative Commons License" class="float-right" style="border-width:0; display: inline-block; margin:0" src="https://i.creativecommons.org/l/by/4.0/88x31.png" aria-hidden="true" />
        
        <strong><i class="far fa-question-circle" aria-hidden="true"></i> Questions:</strong>
        <ul>
        
        <li><p>How do I change Galaxy configs?</p>
</li>
        
        <li><p>How can I upgrade to a new version?</p>
</li>
        
        <li><p>How do I rollback my changes?</p>
</li>
        
        <li><p>How do I scale Galaxy?</p>
</li>
        
        </ul>

        <strong><i class="fas fa-bullseye" aria-hidden="true"></i> Objectives: </strong>
        <ul>
        
        <li><p>Have an understanding of how to modify Galaxy configuration</p>
</li>
        
        <li><p>Be able to upgrade and scale galaxy</p>
</li>
        
        </ul>

        
        <strong><i class="fas fa-check-circle" aria-hidden="true"></i> Requirements:</strong>
        <ul>
        
        
    <li>
    
        
        
        <a href="/training-material/topics/admin">Galaxy Server administration</a>
        
            <ul>
                
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                            
                            <li> Galaxy Installation on Kubernetes:
                            
                            
                                
                                     <a href="/training-material/topics/admin/tutorials/k8s-deploying-galaxy/tutorial.html"><i class="fas fa-laptop" aria-hidden="true"></i><span class="visually-hidden">tutorial</span> hands-on</a>
                                
                            
                            </li>
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                
            </ul>
        
    
    </li>

        </ul>
        

        
        <div><strong><i class="fas fa-hourglass-half" aria-hidden="true"></i> Time estimation:</strong> 30 minutes</div>
        

        
        <div><strong><i class="fas fa-graduation-cap" aria-hidden="true"></i> Level: </strong>
        


 Intermediate <span class="visually-hidden">Intermediate</span>
<span class="level intermediate" title="Intermediate Tutorial">
  <i class="fas fa-graduation-cap" aria-hidden="true"></i> <i class="fas fa-graduation-cap" aria-hidden="true"></i> <i class="fas fa-graduation-cap" aria-hidden="true"></i>
</span>

</div>
        

        
        

        
        <div id="supporting-materials"><strong><i class="fa fa-external-link" aria-hidden="true"></i> Supporting Materials:</strong></div>
        <ul class="supporting_material">
            
                <li class="btn btn-default supporting_material"><a href="/training-material/topics/admin/slides/introduction.html" title="Topic Overview slides">
                    <i class="fab fa-slideshare" aria-hidden="true"></i> Topic Overview slides
                </a></li>
            

            

            

            

            

            
            
            

            <!-- Check the GTN Video Library for recordings of this tutorial or associated slides -->
            











  



            
        </ul>
        

        <div><strong><i class="far fa-calendar" aria-hidden="true"></i> Last modification:</strong> Jul 6, 2019 </div>
        <div><strong><i class="fas fa-balance-scale" aria-hidden="true"></i> License:</strong>
            
            <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">Tutorial Content is licensed under Creative Commons Attribution 4.0 International License</a>
            
            <a rel="license" href="https://github.com/galaxyproject/training-material/blob/main/LICENSE.md">The GTN Framework is licensed under MIT</a>
        </div>
    </blockquote>

    <div class="container">
        <div class="row">
            <!-- sidebar, which will move to the top on a small screen -->
            <div class="col-sm-2">
                <nav id="toc" data-toggle="toc" class="sticky-top" aria-label="Table of Contents"></nav>
            </div>
            <div class="col-sm-10">
                 

                <h1 id="managing-galaxy-on-kubernetes">Managing <span class="notranslate">Galaxy</span> on Kubernetes</h1>

<h2 class="no_toc" id="overview">Overview</h2>

<p>A primary advantage of <span class="notranslate">Galaxy</span> on <a href="https://kubernetes.io/">Kubernetes</a> is the ease with which common
administrative tasks can be performed reliably and without disruption of
service. In particular, because of containerization, Kubernetes provides a significant
advantage over managing individual virtual machines, where updates to system
libraries or components can cause unexpected breakage of dependent components.
With containerization, this becomes a simpler problem of swapping out a
container and replacing it with an updated version. It also reduces reliance
on the underlying operating system, allowing the OS to be upgraded and
have the latest security patches applied without having to worry about
how it will affect the applications running within. Kubernetes has built-in
functionality for draining a node of all containers and for transparently
moving those containers to a different node, allowing maintenance tasks to be
performed on the underlying node without disruption of service.</p>

<p>In this section, we will look at how to perform common management tasks on
a <span class="notranslate">Galaxy</span> deployment on Kubernetes, including:</p>
<ul>
  <li>How to upgrade a deployment</li>
  <li>Change the configuration of a running <span class="notranslate">Galaxy</span> instance</li>
  <li>Map arbitrary files into <span class="notranslate">Galaxy</span>’s config folder</li>
  <li>Rollback changes in the case of an error</li>
  <li>Scale the number of job and web handlers</li>
  <li>Delete a deployment</li>
</ul>

<blockquote class="agenda">
  <h3 id="agenda">Agenda</h3>

<ol id="markdown-toc">
  <li><a href="#managing-galaxy-on-kubernetes" id="markdown-toc-managing-galaxy-on-kubernetes">Managing <span class="notranslate">Galaxy</span> on Kubernetes</a>    <ol>
      <li><a href="#prerequisites" id="markdown-toc-prerequisites">Prerequisites</a></li>
    </ol>
  </li>
  <li><a href="#changing-the-configuration-of-a-galaxy-instance" id="markdown-toc-changing-the-configuration-of-a-galaxy-instance">Changing the configuration of a <span class="notranslate">Galaxy</span> instance</a>    <ol>
      <li><a href="#changing-tool-configuration" id="markdown-toc-changing-tool-configuration">Changing tool configuration</a></li>
      <li><a href="#setting-the-admin-user-and-changing-the-brand" id="markdown-toc-setting-the-admin-user-and-changing-the-brand">Setting the admin user and changing the brand</a></li>
    </ol>
  </li>
  <li><a href="#scaling-galaxy" id="markdown-toc-scaling-galaxy">Scaling <span class="notranslate">Galaxy</span></a></li>
  <li><a href="#testing-kubernetes-resilience" id="markdown-toc-testing-kubernetes-resilience">Testing Kubernetes resilience</a></li>
  <li><a href="#deleting-galaxy" id="markdown-toc-deleting-galaxy">Deleting <span class="notranslate">Galaxy</span></a></li>
  <li><a href="#next-steps" id="markdown-toc-next-steps">Next Steps</a></li>
</ol>

</blockquote>

<h2 id="prerequisites">Prerequisites</h2>
<p>This tutorial builds on the material of the previous
<a href="/training-material/topics/admin/tutorials/k8s-deploying-galaxy/tutorial.html">tutorial</a>
and we recommend following it first to setup the required environment.
You must have some familiarity with Helm commands, know how to change values
in a Helm Chart and how to use the <code class="language-plaintext highlighter-rouge">kubectl</code> command.</p>

<h1 id="changing-the-configuration-of-a-galaxy-instance">Changing the configuration of a <span class="notranslate">Galaxy</span> instance</h1>
<p>We will start off by looking at how to change the configuration of a <span class="notranslate">Galaxy</span>
instance. We will first reduce the number of tools that are loaded for faster
startup, and then change some common settings in <code class="language-plaintext highlighter-rouge"><span class="notranslate">galaxy</span>.yml</code>.</p>

<h2 id="changing-tool-configuration">Changing tool configuration</h2>
<p>We will change the <span class="notranslate">Galaxy</span> configuration to limit the initial list of tools
that <span class="notranslate">Galaxy</span> will use by pointing to our custom <code class="language-plaintext highlighter-rouge">tool_conf.xml</code>. This will make
your chart start up much faster for the remainder of this tutorial, as the
default configuration loads the full list of tools used by
<a href="https://usegalaxy.org/">https://use<span class="notranslate">galaxy</span>.org/</a>.</p>

<blockquote class="notranslate hands_on">
  <h3 id="hands_on-hands-on-creating-a-custom-tool-set"><i class="fas fa-pencil-alt" aria-hidden="true"></i><span class="visually-hidden">hands_on</span> Hands-on: Creating a custom tool set</h3>

  <ol>
    <li>
      <p>First, let’s create a simpler list of tools by saving the following tool
config as a file called <code class="language-plaintext highlighter-rouge">custom_tool_conf.xml</code>.</p>

      <div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?xml version="1.0" ?&gt;</span>
<span class="nt">&lt;toolbox</span> <span class="na">tool_path=</span><span class="s">"/cvmfs/main.<span class="notranslate">galaxy</span>project.org/shed_tools"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;section</span> <span class="na">id=</span><span class="s">"get_data"</span> <span class="na">name=</span><span class="s">"Get Data"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;tool</span> <span class="na">file=</span><span class="s">"data_source/upload.xml"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/section&gt;</span>
    <span class="nt">&lt;section</span> <span class="na">id=</span><span class="s">"chip_seq"</span> <span class="na">name=</span><span class="s">"ChIP-seq"</span> <span class="na">version=</span><span class="s">""</span><span class="nt">&gt;</span>
        <span class="nt">&lt;tool</span> <span class="na">file=</span><span class="s">"<span class="notranslate">toolshed</span>.g2.bx.psu.edu/repos/<span class="notranslate">rna</span>team/chipseeker/1b9a9409831d/chipseeker/chipseeker.xml"</span> <span class="na">guid=</span><span class="s">"<span class="notranslate">toolshed</span>.g2.bx.psu.edu/repos/<span class="notranslate">rna</span>team/chipseeker/chipseeker/1.18.0+<span class="notranslate">galaxy</span>1"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;tool_shed&gt;</span><span class="notranslate">toolshed</span>.g2.bx.psu.edu<span class="nt">&lt;/tool_shed&gt;</span>
            <span class="nt">&lt;repository_name&gt;</span>chipseeker<span class="nt">&lt;/repository_name&gt;</span>
            <span class="nt">&lt;repository_owner&gt;</span><span class="notranslate">rna</span>team<span class="nt">&lt;/repository_owner&gt;</span>
            <span class="nt">&lt;installed_changeset_revision&gt;</span>1b9a9409831d<span class="nt">&lt;/installed_changeset_revision&gt;</span>
            <span class="nt">&lt;id&gt;</span><span class="notranslate">toolshed</span>.g2.bx.psu.edu/repos/<span class="notranslate">rna</span>team/chipseeker/chipseeker/1.18.0+<span class="notranslate">galaxy</span>1<span class="nt">&lt;/id&gt;</span>
            <span class="nt">&lt;version&gt;</span>1.18.0+<span class="notranslate">galaxy</span>1<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;/tool&gt;</span>
    <span class="nt">&lt;/section&gt;</span>
    <span class="nt">&lt;section</span> <span class="na">id=</span><span class="s">"fastq_quality_control"</span> <span class="na">name=</span><span class="s">"FASTQ Quality Control"</span> <span class="na">version=</span><span class="s">""</span><span class="nt">&gt;</span>
        <span class="nt">&lt;tool</span> <span class="na">file=</span><span class="s">"<span class="notranslate">toolshed</span>.g2.bx.psu.edu/repos/pjbriggs/trimmomatic/51b771646466/trimmomatic/trimmomatic.xml"</span> <span class="na">guid=</span><span class="s">"<span class="notranslate">toolshed</span>.g2.bx.psu.edu/repos/pjbriggs/trimmomatic/trimmomatic/0.36.6"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;tool_shed&gt;</span><span class="notranslate">toolshed</span>.g2.bx.psu.edu<span class="nt">&lt;/tool_shed&gt;</span>
            <span class="nt">&lt;repository_name&gt;</span>trimmomatic<span class="nt">&lt;/repository_name&gt;</span>
            <span class="nt">&lt;repository_owner&gt;</span>pjbriggs<span class="nt">&lt;/repository_owner&gt;</span>
            <span class="nt">&lt;installed_changeset_revision&gt;</span>51b771646466<span class="nt">&lt;/installed_changeset_revision&gt;</span>
            <span class="nt">&lt;id&gt;</span><span class="notranslate">toolshed</span>.g2.bx.psu.edu/repos/pjbriggs/trimmomatic/trimmomatic/0.36.6<span class="nt">&lt;/id&gt;</span>
            <span class="nt">&lt;version&gt;</span>0.36.6<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;/tool&gt;</span>
    <span class="nt">&lt;/section&gt;</span>
    <span class="nt">&lt;section</span> <span class="na">id=</span><span class="s">"fastq_quality_control"</span> <span class="na">name=</span><span class="s">"FASTQ Quality Control"</span> <span class="na">version=</span><span class="s">""</span><span class="nt">&gt;</span>
        <span class="nt">&lt;tool</span> <span class="na">file=</span><span class="s">"<span class="notranslate">toolshed</span>.g2.bx.psu.edu/repos/devteam/fastqc/e7b2202befea/fastqc/rgFastQC.xml"</span> <span class="na">guid=</span><span class="s">"<span class="notranslate">toolshed</span>.g2.bx.psu.edu/repos/devteam/fastqc/fastqc/0.72+<span class="notranslate">galaxy</span>1"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;tool_shed&gt;</span><span class="notranslate">toolshed</span>.g2.bx.psu.edu<span class="nt">&lt;/tool_shed&gt;</span>
            <span class="nt">&lt;repository_name&gt;</span>fastqc<span class="nt">&lt;/repository_name&gt;</span>
            <span class="nt">&lt;repository_owner&gt;</span>devteam<span class="nt">&lt;/repository_owner&gt;</span>
            <span class="nt">&lt;installed_changeset_revision&gt;</span>e7b2202befea<span class="nt">&lt;/installed_changeset_revision&gt;</span>
            <span class="nt">&lt;id&gt;</span><span class="notranslate">toolshed</span>.g2.bx.psu.edu/repos/devteam/fastqc/fastqc/0.72+<span class="notranslate">galaxy</span>1<span class="nt">&lt;/id&gt;</span>
            <span class="nt">&lt;version&gt;</span>0.72+<span class="notranslate">galaxy</span>1<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;/tool&gt;</span>
    <span class="nt">&lt;/section&gt;</span>
<span class="nt">&lt;/toolbox&gt;</span>
</code></pre></div>      </div>
    </li>
    <li>
      <p>Next, let’s create a new <code class="language-plaintext highlighter-rouge"><span class="notranslate">galaxy</span>.yml</code> file that uses this <code class="language-plaintext highlighter-rouge">custom_tool_conf.xml</code>.</p>

      <p>Note that the content below is the same as the <code class="language-plaintext highlighter-rouge">configs</code> section of
<code class="language-plaintext highlighter-rouge">values-cvmfs.yaml</code> file from the <span class="notranslate">Galaxy</span> Helm chart with one exception:
<code class="language-plaintext highlighter-rouge">tool_config_file</code> entry is pointing to our custom tool list instead of the
full list from CVMFS.</p>

      <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">uwsgi</span><span class="pi">:</span>
  <span class="na">virtualenv</span><span class="pi">:</span> <span class="s">/<span class="notranslate">galaxy</span>/server/.venv</span>
  <span class="na">processes</span><span class="pi">:</span> <span class="m">1</span>
  <span class="na">http</span><span class="pi">:</span> <span class="s">0.0.0.0:8080</span>
  <span class="na">static-map</span><span class="pi">:</span> <span class="s">/static/style=/<span class="notranslate">galaxy</span>/server/static/style/blue</span>
  <span class="na">static-map</span><span class="pi">:</span> <span class="s">/static=/<span class="notranslate">galaxy</span>/server/static</span>
  <span class="na">static-map</span><span class="pi">:</span> <span class="s">/favicon.ico=/<span class="notranslate">galaxy</span>/server/static/favicon.ico</span>
  <span class="na">pythonpath</span><span class="pi">:</span> <span class="s">/<span class="notranslate">galaxy</span>/server/lib</span>
  <span class="na">thunder-lock</span><span class="pi">:</span> <span class="no">true</span>
  <span class="na">manage-script-name</span><span class="pi">:</span> <span class="no">true</span>
  <span class="na">mount</span><span class="pi">:</span> <span class="pi">{{</span><span class="nv">.Values.ingress.path</span><span class="pi">}}</span><span class="s">=<span class="notranslate">galaxy</span>.webapps.<span class="notranslate">galaxy</span>.buildapp:uwsgi_app()</span>
  <span class="na">buffer-size</span><span class="pi">:</span> <span class="m">16384</span>
  <span class="na">offload-th<span class="notranslate">reads</span></span><span class="pi">:</span> <span class="m">2</span>
  <span class="na">th<span class="notranslate">reads</span></span><span class="pi">:</span> <span class="m">4</span>
  <span class="na">die-on-term</span><span class="pi">:</span> <span class="no">true</span>
  <span class="na">master</span><span class="pi">:</span> <span class="no">true</span>
  <span class="na">hook-master-start</span><span class="pi">:</span> <span class="s">unix_signal:2 gracefully_kill_them_all</span>
  <span class="na">enable-th<span class="notranslate">reads</span></span><span class="pi">:</span> <span class="no">true</span>
  <span class="na">py-call-osafterfork</span><span class="pi">:</span> <span class="no">true</span>
<span class="na"><span class="notranslate">galaxy</span></span><span class="pi">:</span>
  <span class="na">database_connection</span><span class="pi">:</span> <span class="s1">'</span><span class="s">postgresql://{{.Values.postgresql.<span class="notranslate">galaxy</span>DatabaseUser}}:{{.Values.postgresql.<span class="notranslate">galaxy</span>DatabasePassword}}@{{</span><span class="nv"> </span><span class="s">template</span><span class="nv"> </span><span class="s">"<span class="notranslate">galaxy</span>-postgresql.fullname"</span><span class="nv"> </span><span class="s">.</span><span class="nv"> </span><span class="s">}}/<span class="notranslate">galaxy</span>'</span>
  <span class="na">integrated_tool_panel_config</span><span class="pi">:</span> <span class="s2">"</span><span class="s">/<span class="notranslate">galaxy</span>/server/config/mutable/integrated_tool_panel.xml"</span>
  <span class="na">sanitize_whitelist_file</span><span class="pi">:</span> <span class="s2">"</span><span class="s">/<span class="notranslate">galaxy</span>/server/config/mutable/sanitize_whitelist.txt"</span>
  <span class="na">tool_config_file</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{.Values.persistence.mountPath}}/config/editable_shed_tool_conf.xml,/<span class="notranslate">galaxy</span>/server/config/custom_tool_conf.xml"</span>
  <span class="na">tool_data_table_config_path</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">.Values.cvmfs.main.mountPath</span><span class="nv"> </span><span class="s">}}/config/shed_tool_data_table_conf.xml,{{.Values.cvmfs.data.mountPath}}/managed/location/tool_data_table_conf.xml,{{.Values.cvmfs.data.mountPath}}/byhand/location/tool_data_table_conf.xml"</span>
  <span class="na">tool_dependency_dir</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{.Values.persistence.mountPath}}/deps"</span>
  <span class="na">builds_file_path</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{.Values.cvmfs.data.mountPath}}/managed/location/builds.txt"</span>
  <span class="na">datatypes_config_file</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">.Values.cvmfs.main.mountPath</span><span class="nv"> </span><span class="s">}}/config/datatypes_conf.xml"</span>
  <span class="na">containers_resolvers_config_file</span><span class="pi">:</span> <span class="s2">"</span><span class="s">/<span class="notranslate">galaxy</span>/server/config/container_resolvers_conf.xml"</span>
  <span class="na">workflow_schedulers_config_file</span><span class="pi">:</span> <span class="s2">"</span><span class="s">/<span class="notranslate">galaxy</span>/server/config/workflow_schedulers_conf.xml"</span>
  <span class="na">build_sites_config_file</span><span class="pi">:</span> <span class="s2">"</span><span class="s">/<span class="notranslate">galaxy</span>/server/config/build_sites.yml"</span>
</code></pre></div>      </div>
    </li>
    <li>
      <p>Now, let’s upgrade the chart to use <code class="language-plaintext highlighter-rouge">custom_tool_conf.xml</code> and
<code class="language-plaintext highlighter-rouge"><span class="notranslate">galaxy</span>.yml</code> by running the <code class="language-plaintext highlighter-rouge">helm upgrade</code> command.</p>

      <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>helm upgrade <span class="nt">--reuse-values</span> <span class="nt">--set-file</span> <span class="s2">"configs.custom_tool_conf</span><span class="se">\.</span><span class="s2">xml"</span><span class="o">=</span>custom_tool_conf.xml <span class="nt">--set-file</span> <span class="s2">"configs.<span class="notranslate">galaxy</span></span><span class="se">\.</span><span class="s2">yml"</span><span class="o">=</span>configs/<span class="notranslate">galaxy</span>.yml <span class="notranslate">galaxy</span> <span class="notranslate">galaxy</span>/<span class="notranslate">galaxy</span>
</code></pre></div>      </div>

      <p>Note the <code class="language-plaintext highlighter-rouge">--reuse-values</code> flag, which instructs Helm to reuse any
previously set values, and apply the new ones on top.  The <code class="language-plaintext highlighter-rouge">--set-file</code>
option will set the value of the <code class="language-plaintext highlighter-rouge">configs.custom_tool_conf.xml</code>
key in your values file to the contents of the specified file, as a text
string. Each file under <code class="language-plaintext highlighter-rouge">configs</code> key in <code class="language-plaintext highlighter-rouge">values.yaml</code> is automatically
mapped into <span class="notranslate">Galaxy</span>’s <code class="language-plaintext highlighter-rouge">config</code> directory within the running container.</p>
    </li>
    <li>
      <p>Notice that while the chart is upgrading, the existing version continues
to function. The changeover will occur when the new container is online
and signals readiness to Kubernetes by responding to web requests on
the relevant port. Log into the Kubernetes dashboard and watch the logs
as the new pods come online.</p>
    </li>
    <li>
      <p>List the installed helm charts again and note that the revision of the chart
has changed. These revisions are useful because it allows us to rollback
our changes if they are incorrect. This will be covered in a later section.</p>

      <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>helm list
NAME  	REVISION	UPDATED                 	STATUS  	CHART                 	APP VERSION	NAMESPACE
cvmfs 	1       	Wed Jun 26 14:47:46 2019	DEPLOYED	<span class="notranslate">galaxy</span>-cvmfs-csi-1.0.1	1.0        	cvmfs
<span class="notranslate">galaxy</span>	2       	Wed Jun 26 14:51:17 2019	DEPLOYED	<span class="notranslate">galaxy</span>-3.0.0          	v19.05     	default
</code></pre></div>      </div>
    </li>
    <li>
      <p>Let’s now exec into the running container and check where the files were
mapped in. First, let’s get a list of running pods.</p>

      <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl get pods
NAME                          READY   STATUS    RESTARTS   AGE
<span class="notranslate">galaxy</span>-<span class="notranslate">galaxy</span>-postgres-0      1/1     Running   0          2d6h
<span class="notranslate">galaxy</span>-job-69864b6797-zs5mn   1/1     Running   0          2d6h
<span class="notranslate">galaxy</span>-web-7568c58b94-jzkvm   1/1     Running   0          2d6h
</code></pre></div>      </div>

      <p>Exec into the web pod by running:</p>

      <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl <span class="nb">exec</span> <span class="nt">-it</span> <span class="notranslate">galaxy</span>-web-7568c58b94-jzkvm /bin/bash
</code></pre></div>      </div>

      <p>Now run <code class="language-plaintext highlighter-rouge">ls /<span class="notranslate">galaxy</span>/server/config/</code> and note that the <code class="language-plaintext highlighter-rouge"><span class="notranslate">galaxy</span>.yml</code> contains
the content that you’ve provided and that <code class="language-plaintext highlighter-rouge">custom_tool_conf.xml</code> has also been
mapped into the config folder. In this same way, any of <span class="notranslate">Galaxy</span>’s config
files can be overridden by simply <span class="notranslate">mapping</span> in the relevant file into the
config folder.</p>
    </li>
  </ol>
</blockquote>

<h2 id="setting-the-admin-user-and-changing-the-brand">Setting the admin user and changing the brand</h2>
<p>Next, we will set the admin user and change the brand in <code class="language-plaintext highlighter-rouge"><span class="notranslate">galaxy</span>.yml</code>. We will
rollback our change to understand how Helm manages configuration.</p>

<blockquote class="notranslate hands_on">
  <h3 id="hands_on-hands-on-setting-admin-user-and-changing-the-brand"><i class="fas fa-pencil-alt" aria-hidden="true"></i><span class="visually-hidden">hands_on</span> Hands-on: Setting admin user and changing the brand</h3>

  <ol>
    <li>
      <p>Modify the following entries in your <code class="language-plaintext highlighter-rouge"><span class="notranslate">galaxy</span>.yml</code>. Make sure to add these
keys under the <code class="language-plaintext highlighter-rouge"><span class="notranslate">galaxy</span>:</code> section of the file.</p>

      <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>brand: "Hello World"
admin_users: "admin@mydomain.com"
</code></pre></div>      </div>
    </li>
    <li>
      <p>Now, let’s upgrade the chart to apply the new configuration.</p>

      <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>helm upgrade <span class="nt">--reuse-values</span> <span class="nt">--set-file</span> <span class="s2">"configs.<span class="notranslate">galaxy</span></span><span class="se">\.</span><span class="s2">yml"</span><span class="o">=</span><span class="notranslate">galaxy</span>.yml <span class="notranslate">galaxy</span> <span class="notranslate">galaxy</span>/<span class="notranslate">galaxy</span>
</code></pre></div>      </div>
    </li>
    <li>
      <p>Inspect the currently set Helm values by:</p>

      <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>helm get values <span class="notranslate">galaxy</span>
</code></pre></div>      </div>
    </li>
    <li>
      <p>List the installed Helm charts again and note that the revision of the chart has changed as expected.</p>

      <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>helm list
NAME  	REVISION	UPDATED                 	STATUS  	CHART                 	APP VERSION	NAMESPACE
cvmfs 	1       	Wed Jun 26 14:47:46 2019	DEPLOYED	<span class="notranslate">galaxy</span>-cvmfs-csi-1.0.1	1.0        	cvmfs
<span class="notranslate">galaxy</span>	3       	Wed Jun 26 14:51:17 2019	DEPLOYED	<span class="notranslate">galaxy</span>-3.0.0          	v19.05     	default
</code></pre></div>      </div>
    </li>
    <li>
      <p>Let’s now roll back to the previous revision.</p>

      <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>helm rollback <span class="notranslate">galaxy</span> 2
</code></pre></div>      </div>

      <p>Use <code class="language-plaintext highlighter-rouge">helm get values</code> again to observe that the values have reverted to
the previous revision. After a short while, once the new container is up
and running, Kubernetes will automatically switch over to it and you can
see that the previous configuration has been restored.</p>
    </li>
  </ol>

</blockquote>

<h1 id="scaling-galaxy">Scaling <span class="notranslate">Galaxy</span></h1>
<p>In <span class="notranslate">Galaxy</span> deployment on Kubernetes, there are two containers by default, one
web handler and one job handler. We will now look at how these can be scaled.</p>

<blockquote class="notranslate hands_on">
  <h3 id="hands_on-hands-on-setting-admin-user-and-changing-the-brand-1"><i class="fas fa-pencil-alt" aria-hidden="true"></i><span class="visually-hidden">hands_on</span> Hands-on: Setting admin user and changing the brand</h3>

  <ol>
    <li>
      <p>View the <code class="language-plaintext highlighter-rouge">values-cvmfs.yaml</code> file in the <span class="notranslate">Galaxy</span> Helm chart and note down the
number of web and job handlers.</p>

      <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">webHandlers</span><span class="pi">:</span>
    <span class="na">replicaCount</span><span class="pi">:</span> <span class="m">1</span>
<span class="na">jobHandlers</span><span class="pi">:</span>
    <span class="na">replicaCount</span><span class="pi">:</span> <span class="m">1</span>
</code></pre></div>      </div>
    </li>
    <li>
      <p>Let’s increase the number of web handlers by simply setting new values for the number of replicas.</p>

      <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>helm upgrade <span class="nt">--reuse-values</span> <span class="nt">--set</span> webHandlers.replicaCount<span class="o">=</span>2 <span class="notranslate">galaxy</span> <span class="notranslate">galaxy</span>/<span class="notranslate">galaxy</span>
</code></pre></div>      </div>
    </li>
    <li>
      <p>Check whether the new replicas have been created.</p>

      <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl get pods
NAME                          READY   STATUS    RESTARTS   AGE
<span class="notranslate">galaxy</span>-<span class="notranslate">galaxy</span>-postgres-0      1/1     Running   0          2d9h
<span class="notranslate">galaxy</span>-job-5cc75c6588-8dsbg   1/1     Running   0          7m13s
<span class="notranslate">galaxy</span>-web-7c9576cf89-49nlm   1/1     Running   0          7m13s
<span class="notranslate">galaxy</span>-web-7c9576cf89-r6rcj   0/1     Running   0          9s
</code></pre></div>      </div>
    </li>
    <li>
      <p>Follow the pod logs and check whether the new handler is receiving web requests
as expected.</p>

      <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl logs <span class="nt">-f</span> <span class="notranslate">galaxy</span>-web-7c9576cf89-r6rcj
</code></pre></div>      </div>

      <p>You will notice that Kubernetes automatically load balances requests between the
available web handler replicas in a round-robin fashion.</p>
    </li>
  </ol>

</blockquote>

<h1 id="testing-kubernetes-resilience">Testing Kubernetes resilience</h1>
<p>To observe how Kubernetes handles failures, let’s exec into a running container and
manually kill a process to simulate a possible process failure. Kubernetes
continuously monitors running containers, and attempts to bring the environment
back to the “desired” state. The moment it notices a failure, it will respawn
a new pod to replace the failed one. Typically, a Kubernetes container will also
have a <a href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-probes/">liveness probe</a> defined. A liveness probe can be an http
request to a port, or even a manually executed shell script, which will test
whether the relevant container is healthy, and if not, Kubernetes will immediately
provision a new replacement.</p>

<blockquote class="notranslate hands_on">
  <h3 id="hands_on-hands-on-handling-failures"><i class="fas fa-pencil-alt" aria-hidden="true"></i><span class="visually-hidden">hands_on</span> Hands-on: Handling failures</h3>

  <ol>
    <li>
      <p>First list the available pods.</p>

      <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl get pods
NAME                          READY   STATUS    RESTARTS   AGE
<span class="notranslate">galaxy</span>-<span class="notranslate">galaxy</span>-postgres-0      1/1     Running   0          2d9h
<span class="notranslate">galaxy</span>-job-5cc75c6588-8dsbg   1/1     Running   0          14m
<span class="notranslate">galaxy</span>-web-7c9576cf89-49nlm   1/1     Running   0          14m
<span class="notranslate">galaxy</span>-web-7c9576cf89-r6rcj   0/1     Running   1          7m36s
</code></pre></div>      </div>

      <p>Then exec into one:</p>

      <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl <span class="nb">exec</span> <span class="nt">-it</span> <span class="notranslate">galaxy</span>-web-7c9576cf89-r6rcj /bin/bash
</code></pre></div>      </div>
    </li>
    <li>
      <p>Now kill the main container process.</p>

      <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">kill </span>1
</code></pre></div>      </div>
    </li>
    <li>
      <p>If we run <code class="language-plaintext highlighter-rouge">kubectl get pods</code>, we can notice how Kubernetes immediately
starts a new pod to replace the failed one, bringing the environment back to
the desired state. Take a look at the liveness probe defined for the <span class="notranslate">galaxy</span>
web container in the helm chart source code
(<code class="language-plaintext highlighter-rouge">templates/deployment-web.yaml</code>).</p>
    </li>
  </ol>

</blockquote>

<h1 id="deleting-galaxy">Deleting <span class="notranslate">Galaxy</span></h1>
<p>Finally, let’s take a look at how we can uninstall <span class="notranslate">Galaxy</span> and remove all
related containers.</p>

<blockquote class="notranslate hands_on">
  <h3 id="hands_on-hands-on-deleting-galaxy"><i class="fas fa-pencil-alt" aria-hidden="true"></i><span class="visually-hidden">hands_on</span> Hands-on: Deleting <span class="notranslate">Galaxy</span></h3>

  <ol>
    <li>
      <p>To permanently delete the <span class="notranslate">Galaxy</span> release, run:</p>

      <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>helm delete <span class="nt">--purge</span> <span class="notranslate">galaxy</span>
</code></pre></div>      </div>

      <p>The purge flag instructs helm to permanently remove <span class="notranslate">galaxy</span> from its history.</p>
    </li>
    <li>
      <p>Use <code class="language-plaintext highlighter-rouge">kubectl get pods</code> to verify that the pods have been deleted.</p>
    </li>
  </ol>

</blockquote>

<h1 id="next-steps">Next Steps</h1>
<p>This tutorial provided an overview of some common <span class="notranslate">Galaxy</span> administration tasks.
Advanced customizations would include running custom shell scripts on <span class="notranslate">Galaxy</span>
startup to perform additional tasks, running additional containers on
startup, administering and managing storage, building custom <span class="notranslate">Galaxy</span> containers
with desired modifications etc. For more info on some of these
topics, take a look at the <a href="https://github.com/galaxyproject/galaxy-helm"><span class="notranslate">Galaxy</span> Helm chart</a> repository as well as
<a href="../..">other tutorials</a> tagged with <em>kubernetes</em>. Also, feel free to reach out
on Gitter: <a href="https://gitter.im/galaxyproject/FederatedGalaxy">https://gitter.im/<span class="notranslate">galaxy</span>project/Federated<span class="notranslate">Galaxy</span></a>.</p>



                
                <blockquote class="key_points">
                    <h3><i class="fas fa-key" aria-hidden="true"></i> Key points</h3>
                    <ul>
                        
                        <li><p>Modifying configuration is a matter of having some local config files that are mapped in their entirety into the Galaxy container.</p>
</li>
                        
                        <li><p>Scaling is a simple matter of changing the number of replicas.</p>
</li>
                        
                        <li><p>K8S enables zero downtime upgrades and sets the stage for continuous delivery</p>
</li>
                        
                    </ul>
                </blockquote>
                

                <h1>Frequently Asked Questions</h1>
                Have questions about this tutorial? Check out the  <a href="/training-material/topics/admin/faqs/">FAQ page for the Galaxy Server administration topic</a> to see if your question is listed there.
                If not, please ask your question on the <a href="https://gitter.im/Galaxy-Training-Network/Lobby">GTN Gitter Channel</a> or the
                <a href="https://help.galaxyproject.org">Galaxy Help Forum</a>

                

                

                

                <h1>Feedback</h1>
                <p class="text-muted">Did you use this material as an instructor? Feel free to give us feedback on <a href="https://github.com/galaxyproject/training-material/issues/1452" target="_blank">how it went</a>.
                <br>Did you use this material as a learner or student? Click the form below to leave feedback.<i class="fas fa-hand-point-down"></i>
                </p>

                <div id="feedback-button">
                    <img src="/training-material/shared/images/feedback.png" title="Click to activate" alt="Click here to load Google feedback frame" />
                </div>
                <div id="feedback-form">
                </div>
                <script type="text/javascript">
                    (function (window, document) {
                        function onDocumentReady(fn) {
                            if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
                                fn();
                            } else {
                                document.addEventListener('DOMContentLoaded', fn);
                            }
                        }

                        onDocumentReady(function () {
                            $("#feedback-button").click(function(evt){
                                var e = $(evt.target)
                                e.hide();

                                $("#feedback-form").html(`
                                    <iframe id="feedback-google" class="google-form" src="https://docs.google.com/forms/d/e/1FAIpQLSd4VZptFTQ03kHkMz0JyW9b6_S8geU5KjNE_tLM0dixT3ZQmA/viewform?embedded=true&entry.1235803833=Managing Galaxy on Kubernetes (Galaxy Server administration)">Loading...</iframe>
                                `)
                            })
                        });
                    })(window, document);
                </script>



                <h1>Citing this Tutorial</h1>
                <p>
                    <ol>
                        <li id="citation-text">Nuwan Goonasekera, Enis Afgan, Alex Mahmoud, Pablo Moreno, Sergey Golitsynskiy, 2019 <b>Managing Galaxy on Kubernetes (Galaxy Training Materials)</b>. <a href="https://training.galaxyproject.org/training-material/topics/admin/tutorials/k8s-managing-galaxy/tutorial.html">https://training.galaxyproject.org/training-material/topics/admin/tutorials/k8s-managing-galaxy/tutorial.html</a> Online; accessed TODAY
                        </li>
                        <li>
                        Batut et al., 2018 <b>Community-Driven Data Analysis Training for Biology</b> Cell Systems <a href="https://doi.org/10.1016%2Fj.cels.2018.05.012">10.1016/j.cels.2018.05.012</a>
                        </li>
                    </ol>
                </p>


                <blockquote class="details">
                  <h3><i class="fa fa-info-circle" aria-hidden="true"></i><span class="visually-hidden">details</span> BibTeX</h3>
                  <p style="display: none;">

                <div class="highlighter-rouge"><div class="highlight"><pre class="highlight">
<code id="citation-code">@misc{admin-k8s-managing-galaxy,
author = "Nuwan Goonasekera and Enis Afgan and Alex Mahmoud and Pablo Moreno and Sergey Golitsynskiy",
title = "Managing Galaxy on Kubernetes (Galaxy Training Materials)",
year = "2019",
month = "07",
day = "06"
url = "\url{https://training.galaxyproject.org/training-material/topics/admin/tutorials/k8s-managing-galaxy/tutorial.html}",
note = "[Online; accessed TODAY]"
}
@article{Batut_2018,
    doi = {10.1016/j.cels.2018.05.012},
    url = {https://doi.org/10.1016%2Fj.cels.2018.05.012},
    year = 2018,
    month = {jun},
    publisher = {Elsevier {BV}},
    volume = {6},
    number = {6},
    pages = {752--758.e1},
    author = {B{\'{e}}r{\'{e}}nice Batut and Saskia Hiltemann and Andrea Bagnacani and Dannon Baker and Vivek Bhardwaj and Clemens Blank and Anthony Bretaudeau and Loraine Brillet-Gu{\'{e}}guen and Martin {\v{C}}ech and John Chilton and Dave Clements and Olivia Doppelt-Azeroual and Anika Erxleben and Mallory Ann Freeberg and Simon Gladman and Youri Hoogstrate and Hans-Rudolf Hotz and Torsten Houwaart and Pratik Jagtap and Delphine Larivi{\`{e}}re and Gildas Le Corguill{\'{e}} and Thomas Manke and Fabien Mareuil and Fidel Ram{\'{\i}}rez and Devon Ryan and Florian Christoph Sigloch and Nicola Soranzo and Joachim Wolff and Pavankumar Videm and Markus Wolfien and Aisanjiang Wubuli and Dilmurat Yusuf and James Taylor and Rolf Backofen and Anton Nekrutenko and Björn Grüning},
    title = {Community-Driven Data Analysis Training for Biology},
    journal = {Cell Systems}
}</code>
                </pre></div></div>
                </p>
                </blockquote>


<script type="text/javascript">
// update the date on load, or leave fallback of 'today'
d = new Date();
document.getElementById("citation-code").innerHTML = document.getElementById("citation-code").innerHTML.replace("TODAY", d.toDateString());
document.getElementById("citation-text").innerHTML = document.getElementById("citation-text").innerHTML.replace("TODAY", d.toDateString());
</script>

                <h3><i class="far fa-thumbs-up" aria-hidden="true"></i> Congratulations on successfully completing this tutorial!</h3>

                

                

            </div>
        </div>
    </div>
</section>
<br/>
<br/>
<br/>

        </div>
        
    </body>
    <script type="text/javascript" src="/training-material/assets/js/jquery.slim.min.js"></script>
    <script type="text/javascript" src="/training-material/assets/js/popper.min.js"></script>
    <script type="text/javascript" src="/training-material/assets/js/bootstrap.min.js?v=3"></script>
    <script type="text/javascript" src="/training-material/assets/js/details-element-polyfill.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="/training-material/assets/js/bootstrap-toc.min.js"></script>
    <script type="text/javascript" src="/training-material/assets/js/main.js"></script>
    <script type="text/javascript" src="/training-material/assets/js/theme.js"></script>

    <script type="text/javascript" src="/training-material/assets/js/clipboard.min.js"></script>
    <script type="text/javascript">
    var snippets=document.querySelectorAll('div.highlight');
    [].forEach.call(snippets,function(snippet){
        snippet.firstChild.insertAdjacentHTML('beforebegin','<button class="btn btn-light" data-clipboard-snippet><i class="fa fa-copy"></i>&nbsp;Copy</button>');
    });

    var clipboardSnippets=new ClipboardJS('[data-clipboard-snippet]',{
        target:function(trigger){return trigger.nextElementSibling;
    }});
    </script>
    

    <script type="text/javascript">
        if(window.location.hostname === "galaxyproject.github.io") {
            // Redirect
            var redirect = "https://training.galaxyproject.org" + window.location.pathname + window.location.search;
            $('div.container.main-content').prepend("<div class='alert alert-warning'><strong>Note: </strong>This content has a new home at <a href=\"" + redirect + "\">" + redirect + "</a>, which you will be redirected to in 5 seconds.</div>");

            window.setTimeout(function(){
                window.location.href = redirect;
            }, 5000)

        }
    </script>
</html>
