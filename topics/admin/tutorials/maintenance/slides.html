<!DOCTYPE html>
<html>











  <head>
    <meta charset="utf-8">
    <title>Server Maintenance and Backups</title>
    
        <script async defer data-domain="training.galaxyproject.org" src="https://plausible.galaxyproject.eu/js/plausible.js"></script>

    
    <link rel="stylesheet" href="/training-material/assets/css/slides.css">
    <script src="https://kit.fontawesome.com/67b3f98409.js" crossorigin="anonymous"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="shortcut icon" href="/training-material/favicon.ico" type="image/x-icon" />

    
    
    
    
    <meta name="description" content="Resources related to configuration and maintenance of Gal..." />
    <meta property="og:title" content="Galaxy Training: Server Maintenance and Backups" />
    <meta property="og:description" content="Resources related to configuration and maintenance of Gal..." />
    <meta property="og:image" content="/training-material/assets/images/GTNLogo1000.png" />
    <script type="application/ld+json">
      


{
  "@context": "http://schema.org",
  "@type": "Course",
  "accessMode": [
    "textual",
    "visual"
  ],
  "accessModeSufficient": [
    "textual",
    "visual"
  ],
  "accessibilityControl": [
    "fullKeyboardControl",
    "fullMouseControl"
  ],
  "accessibilityFeature": [
    "alternativeText",
    "tableOfContents"
  ],
  "accessibilitySummary": "Short descriptions are present but long descriptions will be needed for non-visual users",
  "audience": {
    "@type": "EducationalAudience",
    "educationalRole": "students"
  },
  "citation": {
    "@type": "CreativeWork",
    "name": "Community-Driven Data Analysis Training for Biology",
    "url": "https://doi.org/10.1016/j.cels.2018.05.012"
  },
  "copyrightHolder": {
    "@type": "Organization",
    "email": "galaxytrainingnetwork@gmail.com",
    "name": "Galaxy Training Network",
    "url": "https://galaxyproject.org/teach/gtn/"
  },
  "dateModified": "1970-01-01 00:33:41 +0000",
  "discussionUrl": "https://gitter.im/Galaxy-Training-Network/Lobby",
  "headline": "Server Maintenance and Backups",
  "interactivityType": "mixed",
  "isAccessibleForFree": true,
  "isFamilyFriendly": true,
  "license": "https://spdx.org/licenses/CC-BY-4.0.html",
  "producer": {
    "@type": "Organization",
    "email": "galaxytrainingnetwork@gmail.com",
    "name": "Galaxy Training Network",
    "url": "https://galaxyproject.org/teach/gtn/"
  },
  "provider": {
    "@type": "Organization",
    "email": "galaxytrainingnetwork@gmail.com",
    "name": "Galaxy Training Network",
    "url": "https://galaxyproject.org/teach/gtn/"
  },
  "sourceOrganization": {
    "@type": "Organization",
    "email": "galaxytrainingnetwork@gmail.com",
    "name": "Galaxy Training Network",
    "url": "https://galaxyproject.org/teach/gtn/"
  },
  "isPartOf": {
    "@type": "CreativeWork",
    "name": "Galaxy Server administration",
    "description": "Resources related to configuration and maintenance of Galaxy servers",
    "url": "https://training.galaxyproject.org//training-material/topics/admin/"
  },
  "courseCode": "admin / maintenance / slides",
  "learningResourceType": "slides",
  "name": "Slides for 'Server Maintenance and Backups' tutorial",
  "url": "https://training.galaxyproject.org//training-material/topics/admin/tutorials/maintenance/slides.html",
  "timeRequired": "PT30M",
  "description": "The questions this  addresses are:\n - How do I maintain a Galaxy server?\n - What happens if I lose everything?\n\n\\nThe objectives are:\n - Learn about different maintenance steps\n - Learn what to back up and how to recover\n\n",
  "inLanguage": {
    "@type": "Language",
    "name": "English",
    "alternateName": "en"
  },
  "hasPart": [

  ],
  "author": [
    {
      "@type": "Person",
      "name": "Nate Coraor"
    },
    {
      "@type": "Person",
      "name": "Björn Grüning"
    },
    {
      "@type": "Person",
      "name": "Simon Gladman"
    },
    {
      "@type": "Person",
      "name": "Helena Rasche"
    }
  ],
  "contributor": [
    {
      "@type": "Person",
      "name": "Nate Coraor"
    },
    {
      "@type": "Person",
      "name": "Björn Grüning"
    },
    {
      "@type": "Person",
      "name": "Simon Gladman"
    },
    {
      "@type": "Person",
      "name": "Helena Rasche"
    }
  ],
  "about": [
    {
      "@type": "CreativeWork",
      "name": "Galaxy Server administration",
      "description": "Resources related to configuration and maintenance of Galaxy servers",
      "url": "https://training.galaxyproject.org//training-material/topics/admin/"
    }
  ]
}
    </script>
    <script type="text/javascript" src="/training-material/assets/js/jquery.slim.min.js"></script>
  </head>
  <body>
    <textarea id="source">
name: inverse
layout: true
class: center, middle, inverse

<div class="my-header"><span>
<a href="/training-material/topics/admin" title="Return to topic page" ><i class="fa fa-level-up" aria-hidden="true"></i></a>

<a class="nav-link" href="https://github.com/galaxyproject/training-material/edit/main/topics/admin/tutorials/maintenance/slides.html"><i class="fa fa-pencil" aria-hidden="true"></i></a>

</span></div>

<div class="my-footer"><span>

  
<img src="/training-material/assets/images/gat.png" alt="page logo" style="height: 40px;"/>
  

</span></div>

---



  
<img src="/training-material/assets/images/gat.png" alt="page logo" class="cover-logo" />
  


# Server Maintenance and Backups


<div class="contributors-line">

<a href="/training-material/hall-of-fame/natefoo/" class="contributor-badge contributor-natefoo"><img src="https://avatars.githubusercontent.com/natefoo?s=27" alt="Avatar">Nate Coraor</a>


<a href="/training-material/hall-of-fame/bgruening/" class="contributor-badge contributor-bgruening"><img src="https://avatars.githubusercontent.com/bgruening?s=27" alt="Avatar">Björn Grüning</a>


<a href="/training-material/hall-of-fame/slugger70/" class="contributor-badge contributor-slugger70"><img src="https://avatars.githubusercontent.com/slugger70?s=27" alt="Avatar">Simon Gladman</a>


<a href="/training-material/hall-of-fame/hexylena/" class="contributor-badge contributor-hexylena"><img src="https://avatars.githubusercontent.com/hexylena?s=27" alt="Avatar">Helena Rasche</a>


<a href="https://training.galaxyproject.org/training-material/topics/contributing/" class="contributor-badge contributor-newcontributors"><i class="fas fa-users" aria-hidden="true"></i><span class="visually-hidden">hall-of-fame</span>Add Contributions!</a>


</div>


<div class="footnote" style="bottom: 5.5em;"><i class="far fa-calendar" aria-hidden="true"></i><span class="visually-hidden">last_modification</span> Updated: Apr 6, 2021</div>

<div class="footnote" style="bottom: 4em;"><a href="/training-material/videos/watch.html?v=/admin/tutorials/maintenance/slides"><i class="far fa-play-circle" aria-hidden="true"></i><span class="visually-hidden">video-slides</span> View video slides for this lecture</a></div>

<div class="footnote" style="bottom: 2.5em;"><i class="fas fa-file-alt" aria-hidden="true"></i><span class="visually-hidden">text-document</span><a href="slides-plain.html"> Plain-text slides</a></div>
<div class="footnote" style="bottom: 1em;"><strong>Tip: </strong>press <kbd>P</kbd> to view the presenter notes</div>

???
Presenter notes contain extra information which might be useful if you intend to use these slides for teaching.

Press `P` again to switch presenter notes off

Press `C` to create a new window where the same presentation will be displayed.
This window is linked to the main window. Changing slides on one will cause the
slide to change on the other.

Useful when presenting.



---







### &lt;i class=&quot;far fa-question-circle&quot; aria-hidden=&quot;true&quot;&gt;&lt;/i&gt;&lt;span class=&quot;visually-hidden&quot;&gt;question&lt;/span&gt; Questions


- How do I maintain a Galaxy server?

- What happens if I lose everything?


---



### &lt;i class=&quot;fas fa-bullseye&quot; aria-hidden=&quot;true&quot;&gt;&lt;/i&gt;&lt;span class=&quot;visually-hidden&quot;&gt;objectives&lt;/span&gt; Objectives


- Learn about different maintenance steps

- Learn what to back up and how to recover


---


# Server Maintenance

???

- Server Maintenance

---

## Dataset Cleanup

Can only delete (or purge) dataset when all 'associations' pointing at it have been marked `deleted`.

| method | description |
| ---- | ---- |
| `scripts/cleanup_datasets/pgcleanup.py` | PostgreSQL-optimized fast cleanup script |
| `scripts/cleanup_datasets/cleanup_datasets.py` | General cleanup script |
| `gxadmin cleanup &lt;days&gt;` | calls pgcleanup |

???

- One of the important admimn tasks is to keep an eye on the storage consumption.
- Every instance should have a data rention policy defined and shared with users.
- Codebase contains scripts that can assist with cleaning up and reclaiming space.
- The gxadmin tool can assist with invoking these scripts.

---
class: reduce70

## pgcleanup invocation

```console
$ ./scripts/cleanup_datasets/pgcleanup.py --help
usage: pgcleanup.py [-h] [-c CONFIG_FILE] [-d] [--dry-run] [--force-retry]
                    [-o DAYS] [-U] [-s SEQUENCE] [-w WORK_MEM] [-l LOG_DIR]
                    [ACTION [ACTION ...]]

positional arguments:
  ACTION                Action(s) to perform, chosen from: delete_datasets,
                        delete_exported_histories, delete_inactive_users,
                        delete_userless_histories, purge_datasets,
                        purge_deleted_hdas, purge_deleted_histories,
                        purge_deleted_users, purge_error_hdas,
                        purge_hdas_of_purged_histories,
                        purge_historyless_hdas, update_hda_purged_flag

optional arguments:
  -h, --help            show this help message and exit
  -c CONFIG_FILE, --config-file CONFIG_FILE, --config CONFIG_FILE
                        Galaxy config file (defaults to
                        $GALAXY_ROOT/config/galaxy.yml if that file exists or
                        else to ./config/galaxy.ini if that exists). If this
                        isn't set on the command line it can be set with the
                        environment variable GALAXY_CONFIG_FILE.
  -d, --debug           Enable debug logging (SQL queries)
  --dry-run             Dry run (rollback all transactions)
  --force-retry         Retry file removals (on applicable actions)
  -o DAYS, --older-than DAYS
                        Only perform action(s) on objects that have not been
                        updated since the specified number of days
  -U, --no-update-time  Don't set update_time on updated objects
  -s SEQUENCE, --sequence SEQUENCE
                        DEPRECATED: Comma-separated sequence of actions
  -w WORK_MEM, --work-mem WORK_MEM
                        Set PostgreSQL work_mem for this connection
  -l LOG_DIR, --log-dir LOG_DIR
                        Log file directory
```

???

- Cleanup scripts provide various options for filtering on which datasets to take action.
- Use the dry run option to verify what datasets you are about to affect.

---
class: reduce70

## pgcleanup actions

| action | description |
| ---- | ---- |
| `delete_userless_histories` | &lt;ul&gt;&lt;li&gt;Mark deleted all &quot;anonymous&quot; Histories (not owned by a registered user) that are older than the specified number of days.&lt;/li&gt;&lt;/ul&gt; |
| `delete_exported_histories` | &lt;ul&gt;&lt;li&gt;Mark deleted all Datasets that are derivative of JobExportHistoryArchives that are older than the specified number of days.&lt;/li&gt;&lt;/ul&gt; |
| `purge_deleted_users` | &lt;ul&gt;&lt;li&gt;Mark purged all users that are older than the specified number of days.&lt;/li&gt;&lt;li&gt;Mark purged all Histories whose user_ids are purged in this step.&lt;/li&gt;&lt;li&gt;Mark purged all HistoryDatasetAssociations whose history_ids are purged in this step.&lt;/li&gt;&lt;li&gt;Delete all UserGroupAssociations whose user_ids are purged in this step.&lt;/li&gt;&lt;li&gt;Delete all UserRoleAssociations whose user_ids are purged in this step EXCEPT FOR THE PRIVATE ROLE.&lt;/li&gt;&lt;li&gt;Delete all UserAddresses whose user_ids are purged in this step.&lt;/li&gt;&lt;/ul&gt; |
| `purge_deleted_histories` | &lt;ul&gt;&lt;li&gt;Mark purged all Histories marked deleted that are older than the specified number of days.&lt;/li&gt;&lt;li&gt;Mark purged all HistoryDatasetAssociations in Histories marked purged in this step (if not already purged).&lt;/li&gt;&lt;/ul&gt; |
| `purge_deleted_hdas` | &lt;ul&gt;&lt;li&gt;Mark purged all HistoryDatasetAssociations currently marked deleted that are older than the specified number of days.&lt;/li&gt;&lt;li&gt;Mark deleted all MetadataFiles whose hda_id is purged in this step.&lt;/li&gt;&lt;li&gt;Mark deleted all ImplicitlyConvertedDatasetAssociations whose hda_parent_id is purged in this step.&lt;/li&gt;&lt;li&gt;Mark purged all HistoryDatasetAssociations for which an ImplicitlyConvertedDatasetAssociation with matching hda_id is deleted in this step.&lt;/li&gt;&lt;/ul&gt; |

???

- Some available actions are safer than others, for example &quot;delete userless histories&quot;.
- In Galaxy, when something is marked deleted, it still exists with a deleted flag.
- Once purged the file is gone.

---
class: reduce70

## More pgcleanup actions

| action | description |
| ---- | ---- |
| `purge_historyless_hdas` | &lt;ul&gt;&lt;li&gt;Mark purged all HistoryDatasetAssociations whose history_id is null.&lt;/li&gt;&lt;/ul&gt; |
| `purge_error_hdas` | &lt;ul&gt;&lt;li&gt;Mark purged all HistoryDatasetAssociations whose dataset_id is state = 'error' that are older than the specified number of days.&lt;/li&gt;&lt;/ul&gt; |
| `purge_hdas_of_purged_histories` | &lt;ul&gt;&lt;li&gt;Mark purged all HistoryDatasetAssociations in histories that are purged and older than the specified number of days.&lt;/li&gt;&lt;/ul&gt; |
| `delete_datasets` | &lt;ul&gt;&lt;li&gt;Mark deleted all Datasets whose associations are all marked as deleted (LDDA) or purged (HDA) that are older than the specified number of days.&lt;/li&gt;&lt;li&gt;JobExportHistoryArchives have no deleted column, so the datasets for these will simply be deleted after the specified number of days.&lt;/li&gt;&lt;/ul&gt; |
| `purge_datasets` | &lt;ul&gt;&lt;li&gt;Mark purged all Datasets marked deleted that are older than the specified number of days.&lt;/li&gt;&lt;/ul&gt; |

???

- Be wary about aggressive storage reclamation. It can aggravate users.
- Well-defined and updated data retention policy brings benefits.

---
# Additional cleaning scripts

* `admin_cleanup_datasets.py`
  * Mark datasets as deleted that are older than specified cutoff.
  * Has email templated notification (can also be used to just send info without deleting).
  * Can be restricted to a tool.

???

- One of the included scripts can send templated email to the affected users.
- Take advantage of this to give your users some time to backup their data before you reclaim the space.

---

## Other disk space cleanups

- `tmpwatch` (`tmpreaper` on Debian-based distros) your job working directory
  - `cleanup_job` in `galaxy.yml` (defaults to `always` though)
- `tmpwatch` your `new_file_path`
  - `/usr/bin/tmpwatch -v --mtime --dirmtime 7d /srv/galaxy/var/tmp`

???

- Galaxy generates intermediate data as part of the job execution.
- These should be automatically cleaned up unless you change the cleanup_job flag in galaxy's configuration.

---

# Backups

???

- Backups

---
class: left

## What to backup

**Must** be backed up:

| item | path (from tutorials) |
| ---- | ---- |
| Database ([PITR][postgresql-pitr], enable in [galaxyproject.postgresql][ansible-postgresql]) | system dependent |
| Installed shed tools | `/srv/galaxy/var/shed_tools` |
| *Managed* (aka *mutable*) configs | `/srv/galaxy/var/config` |
| Logs (if you like...) | `systemd-journald` |
| Datasets (if you can...) | `/data` |

If absolute reproducibility matters:

| item | path (from tutorials) |
| ---- | ---- |
| Tool dependencies | `/srv/galaxy/var/dependencies` |
| Data manager-installed reference data | `/srv/galaxy/var/tool-data` |

???

- Many parts of Galaxy are convenient to back up since they are straight folder hierarchies.
- Use your system's recommended way to back up galaxy's database.
- If you have local modifications to galaxy's code back up those as well.

---
class: left

## What not to back up

Restorable from Ansible Playbook:

| item | path (from tutorials) |
| ---- | ---- |
| Galaxy | `/srv/galaxy/server` |
| Virtualenv | `/srv/galaxy/venv` |
| *Static* configs | `/srv/galaxy/config` |

Recreatable at runtime:

| item | path (from tutorials) |
| ---- | ---- |
| Anything in *managed/mutable data dir* not previously mentioned | `/srv/galaxy/var` |
| Job working directories | `/srv/galaxy/jobs` |

[postgresql-pitr]: https://www.postgresql.org/docs/current/continuous-archiving.html
[ansible-postgresql]: https://github.com/galaxyproject/ansible-postgresql

---

## Restoring from backups

If lost *database* or *managed/mutable configs*, then **restore these first**

Then run playbook

???

- In case of an incident do not rush even when pressure is piling.
- Careful planning of the restoration procedure will save you from hasty recovery attempts with errors.
- Consider running a recovery drill pretending that e.g. your galaxy machine was wiped.




---
### &lt;i class=&quot;fas fa-key&quot; aria-hidden=&quot;true&quot;&gt;&lt;/i&gt;&lt;span class=&quot;visually-hidden&quot;&gt;keypoints&lt;/span&gt; Key points


- Use configuration management (e.g. Ansible)

- Store configuration management in git

- Back up the parts of Galaxy that can't be recreated







---

## Thank You!

This material is the result of a collaborative work. Thanks to the [Galaxy Training Network](https://training.galaxyproject.org) and all the contributors!


<div class="contributors-line">

<a href="/training-material/hall-of-fame/natefoo/" class="contributor-badge contributor-natefoo"><img src="https://avatars.githubusercontent.com/natefoo?s=27" alt="Avatar">Nate Coraor</a>


<a href="/training-material/hall-of-fame/bgruening/" class="contributor-badge contributor-bgruening"><img src="https://avatars.githubusercontent.com/bgruening?s=27" alt="Avatar">Björn Grüning</a>


<a href="/training-material/hall-of-fame/slugger70/" class="contributor-badge contributor-slugger70"><img src="https://avatars.githubusercontent.com/slugger70?s=27" alt="Avatar">Simon Gladman</a>


<a href="/training-material/hall-of-fame/hexylena/" class="contributor-badge contributor-hexylena"><img src="https://avatars.githubusercontent.com/hexylena?s=27" alt="Avatar">Helena Rasche</a>


</div>



  
<img src="/training-material/assets/images/gat.png" alt="page logo" style="height: 100px;"/>
  


<a rel="license" href="https://creativecommons.org/licenses/by/4.0/">
This material is licensed under the Creative Commons Attribution 4.0 International License</a>.


    </textarea>
	<script src="/training-material/assets/js/remark-latest.min.js" type="text/javascript"></script>
    <script type="text/javascript" src="/training-material/assets/js/theme.js"></script>
    <script type="text/javascript" src="/training-material/assets/js/clipboard.min.js"></script>
    <script type="text/javascript">
      var slideshow = remark.create({navigation: {scroll: false}, ratio: '16:9'});
      var hljs = remark.highlighter.engine;
      var snippets = document.querySelectorAll('code.remark-code');
        [].forEach.call(snippets,function(snippet){
          snippet.firstChild.insertAdjacentHTML('beforebegin','<button class="btn btn-light" data-clipboard-snippet><i class="fa fa-copy"></i>&nbsp;Copy</button>');
        });
      var clipboardSnippets=new ClipboardJS('[data-clipboard-snippet]',{
        target:function(trigger){return trigger.parentElement;
      }});
    </script>

    <script type="text/javascript">
        if(window.location.hostname === "galaxyproject.github.io") {
            // Redirect
            var redirect = "https://training.galaxyproject.org" + window.location.pathname + window.location.search;
            $('body').prepend("<div style='text-align: center'><strong>Note: </strong>This content has a new home at <a href=\"" + redirect + "\">" + redirect + "</a>, which you will be redirected to in 5 seconds.</div>");

            window.setTimeout(function(){
                window.location.href = redirect;
            }, 5000)

        }
    </script>

  </body>
</html>
