<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <title>Ansible</title>
        
            <script async defer data-domain="training.galaxyproject.org" src="https://plausible.galaxyproject.eu/js/plausible.js"></script>

        
        <link rel="stylesheet" href="/training-material/assets/css/bootstrap.min.css?v=3">
        <link rel="stylesheet" href="/training-material/assets/css/bootstrap-toc.min.css">
        <link rel="stylesheet" href="/training-material/assets/css/main.css?v=2">
        <script src="https://kit.fontawesome.com/67b3f98409.js" crossorigin="anonymous"></script>
        <link rel="stylesheet" href="/training-material/assets/css/academicons.css">
        <link rel="stylesheet" href="/training-material/assets/css/syntax_highlighting.css">
        <link rel="shortcut icon" href="/training-material/favicon.ico" type="image/x-icon" />
        <link rel="alternate" type="application/atom+xml" href="/training-material/feed.xml" />

        
        
        
        
        
        <meta name="description" content="Resources related to configuration and maintenance of Gal..." />
        <meta property="og:title" content="Galaxy Training: Ansible" />
        <meta property="og:description" content="Resources related to configuration and maintenance of Gal..." />
        <meta property="og:image" content="/training-material/assets/images/GTNLogo1000.png" />
    </head>
    <body data-spy="scroll" data-target="#toc">
        <header>
    <nav class="navbar navbar-expand-md navbar-dark" aria-label="Site Navigation">
        <div class="container">
            <a class="navbar-brand" href="/training-material/">
                <img src="/training-material/assets/images/GTN-60px.png" height="30" alt="Galaxy Training Network logo">
                Galaxy Training!
            </a>

            <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#top-navbar" aria-controls="top-navbar" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="top-navbar">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        
                        <a class="nav-link" href="/training-material/topics/admin" title="Go back to list of tutorials">
                            <i class="far fa-folder" aria-hidden="true"></i> Galaxy Server administration
                        </a>
                        
                    </li>

                    <li class="nav-item dropdown">
                        <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown" aria-expanded="false" title="Languages">
                            <i class="fas fa-language" aria-hidden="true"></i><span class="visually-hidden">language</span> Languages
                        </a>
                        <div class="dropdown-menu dropdown-menu-right">
                            
                              <strong class="dropdown-header">Automatic Translations</strong>
            
            <a class="dropdown-item" href="https://translate.google.com/translate?hl=jp&sl=en&tl=fr&u=https%3A%2F%2Ftraining.galaxyproject.org/topics/admin/tutorials/ansible/tutorial.html&edit-text=&act=url">
                            Fran√ßais
                            </a>
                            
            <a class="dropdown-item" href="https://translate.google.com/translate?hl=jp&sl=en&tl=ja&u=https%3A%2F%2Ftraining.galaxyproject.org/topics/admin/tutorials/ansible/tutorial.html&edit-text=&act=url">
                            Êó•Êú¨Ë™û
                            </a>
                            
            <a class="dropdown-item" href="https://translate.google.com/translate?hl=jp&sl=en&tl=es&u=https%3A%2F%2Ftraining.galaxyproject.org/topics/admin/tutorials/ansible/tutorial.html&edit-text=&act=url">
                            Espa√±ol
                            </a>
                            
            <a class="dropdown-item" href="https://translate.google.com/translate?hl=jp&sl=en&tl=pt&u=https%3A%2F%2Ftraining.galaxyproject.org/topics/admin/tutorials/ansible/tutorial.html&edit-text=&act=url">
                            Portugu√™s
                            </a>
                            
            <a class="dropdown-item" href="https://translate.google.com/translate?hl=jp&sl=en&tl=ar&u=https%3A%2F%2Ftraining.galaxyproject.org/topics/admin/tutorials/ansible/tutorial.html&edit-text=&act=url">
                            ÿßŸÑÿπÿ±ÿ®Ÿäÿ©
                            </a>
                            
                            <a class="dropdown-item" href="https://translate.google.com/translate?hl=jp&sl=en&tl=&u=https%3A%2F%2Ftraining.galaxyproject.org/topics/admin/tutorials/ansible/tutorial.html&edit-text=&act=url" title="">
                            And more!
                            </a>
                        </div>
                    </li>

                    <li class="nav-item dropdown">
    <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown" aria-expanded="false" title="Help">
        <i class="far fa-question-circle" aria-hidden="true"></i><span class="visually-hidden">help</span> Help
    </a>
    <div class="dropdown-menu dropdown-menu-right">
        <!-- disable Tess for now
        <form method="get" action="https://tess.elixir-europe.org/materials">
            <input type="text" id="search" name="q" value="" style="margin-left: 0.5em;/*! border-radius: 0px; */">
            <input type="hidden" value="Galaxy Training" name="content_provider">
            <input type="submit" value="Search on TeSS" style="width: 92%;border-radius: 0px;margin: 0.5em;background: #f47d20;border: 0px;padding: 0.25em;" class="">
        </form>
        -->

        <a class="dropdown-item" href="/training-material/faq" title="Check our FAQs">
           <i class="far fa-question-circle" aria-hidden="true"></i><span class="visually-hidden">question</span> FAQs
        </a>
        
        <a class="dropdown-item" href="/training-material/topics/admin/faqs/" title="Check our FAQs for the Galaxy Server administration topic">
           <i class="far fa-question-circle" aria-hidden="true"></i><span class="visually-hidden">question</span> Topic FAQs
        </a>
        
        <a class="dropdown-item" href="https://help.galaxyproject.org/" title="Discuss on Galaxy Help">
            <i class="far fa-comments" aria-hidden="true"></i><span class="visually-hidden">feedback</span> Galaxy Help Forum
        </a>
        <a class="dropdown-item" href="https://gitter.im/Galaxy-Training-Network/Lobby" title="Discuss on gitter">
           <i class="fab fa-gitter" aria-hidden="true"></i><span class="visually-hidden">gitter</span> Discuss on Gitter
        </a>
    </div>
</li>


                    <li class="nav-item dropdown">
    <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown" aria-expanded="false" title="Extras">
        <i class="far fa-star" aria-hidden="true"></i><span class="visually-hidden">galaxy-star</span> Extras
    </a>
    <div class="dropdown-menu dropdown-menu-right">

        
        <a class="dropdown-item" href="https://github.com/galaxyproject/training-material/edit/main/topics/admin/tutorials/ansible/tutorial.md" title="Edit on GitHub">
          <i class="fab fa-github" aria-hidden="true"></i><span class="visually-hidden">github</span> Edit on GitHub
        </a>

        <a class="dropdown-item" href="/training-material/stats.html" title="Show view statistics about this repository">
            <i class="fas fa-chart-bar" aria-hidden="true"></i><span class="visually-hidden">galaxy-barchart</span> GTN statistics
        </a>

        <a class="dropdown-item" href="https://plausible.galaxyproject.eu/training.galaxyproject.org?period=12mo&page=/training-material/topics/admin/tutorials/ansible/tutorial.html" title="Show view statistics of this page">
            <i class="fas fa-chart-bar" aria-hidden="true"></i><span class="visually-hidden">galaxy-barchart</span> Page Metrics
        </a>

        
            <a class="dropdown-item" href="/training-material/feedback.html" title="Show feedback statistics about this repository">
                <i class="fas fa-chart-bar" aria-hidden="true"></i><span class="visually-hidden">galaxy-barchart</span> GTN feedback
            </a>
        

        <div class="dropdown-item">
            <div>
                <i class="fas fa-palette" aria-hidden="true"></i><span class="visually-hidden">gtn-theme</span> Theme
            </div>

            <div id="theme-selector" data-toggle="buttons">
                <label data-value="default" class="btn btn-secondary">
                    <input type="radio" name="options" id="default" autocomplete="off"> Default
                </label>
                <label data-value="night" class="btn btn-secondary">
                    <input type="radio" name="options" id="night" autocomplete="off"> Night
                </label>
                <label data-value="midnight" class="btn btn-secondary">
                    <input type="radio" name="options" id="midnight" autocomplete="off"> Midnight
                </label>
                <label data-value="rainbow" class="btn btn-secondary">
                    <input type="radio" name="options" id="rainbow" autocomplete="off"> Rainbow
                </label>
                <label data-value="progress" class="btn btn-secondary">
                    <input type="radio" name="options" id="progress" autocomplete="off">üè≥Ô∏è‚Äçüåà
                </label>
                <label data-value="halloween" class="btn btn-secondary">
                    <input type="radio" name="options" id="halloween" autocomplete="off"> üéÉ
                </label>
                <label data-value="straya" class="btn btn-secondary">
                    <input type="radio" name="options" id="downunder" autocomplete="off"> üá¶üá∫
                </label>
            </div>

        </div>

        <div class="dropdown-item">
            <div>
                <i class="fas fa-history" aria-hidden="true"></i><span class="visually-hidden">galaxy-rulebuilder-history</span> Previous Versions
            </div>

            
            <div id="archive-selector">
            
                <a class="btn btn-warning" href="https://training.galaxyproject.org/archive/" title="Older Versions">Older Versions</a>
            </div>

        </div>

    </div>
</li>


                    <!-- Search bar-->
                    <li class="nav-item">
                      <div id="navbarSupportedContent" role="search">
                        <!-- Search form -->
                        <form class="form-inline mr-auto" method="GET" action="/training-material/search">
                          <i class="fas fa-search nav-link" aria-hidden="true"></i>
                          <div class="md-form mb-2">
                            <input name="query" class="form-control nicer" type="text" placeholder="Search Tutorials" aria-label="Search">
                          </div>
                        </form>
                      </div>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
</header>

        <div class="container main-content" role="main">
        











<!-- Gitter -->




<script>
  ((window.gitter = {}).chat = {}).options = {
  room: 'galaxyproject/admins'
  };
</script>
<script src="https://sidecar.gitter.im/dist/sidecar.v1.js" async defer></script>

<script type="application/ld+json">
    


{
  "@context": "http://schema.org",
  "@type": "Course",
  "accessMode": [
    "textual",
    "visual"
  ],
  "accessModeSufficient": [
    "textual",
    "visual"
  ],
  "accessibilityControl": [
    "fullKeyboardControl",
    "fullMouseControl"
  ],
  "accessibilityFeature": [
    "alternativeText",
    "tableOfContents"
  ],
  "accessibilitySummary": "Short descriptions are present but long descriptions will be needed for non-visual users",
  "audience": {
    "@type": "EducationalAudience",
    "educationalRole": "students"
  },
  "citation": {
    "@type": "CreativeWork",
    "name": "Community-Driven Data Analysis Training for Biology",
    "url": "https://doi.org/10.1016/j.cels.2018.05.012"
  },
  "copyrightHolder": {
    "@type": "Organization",
    "email": "galaxytrainingnetwork@gmail.com",
    "name": "Galaxy Training Network",
    "url": "https://galaxyproject.org/teach/gtn/"
  },
  "dateModified": "1970-01-01 00:00:09 +0000",
  "discussionUrl": "https://gitter.im/Galaxy-Training-Network/Lobby",
  "headline": "Ansible",
  "interactivityType": "mixed",
  "isAccessibleForFree": true,
  "isFamilyFriendly": true,
  "license": "https://spdx.org/licenses/CC-BY-4.0.html",
  "producer": {
    "@type": "Organization",
    "email": "galaxytrainingnetwork@gmail.com",
    "name": "Galaxy Training Network",
    "url": "https://galaxyproject.org/teach/gtn/"
  },
  "provider": {
    "@type": "Organization",
    "email": "galaxytrainingnetwork@gmail.com",
    "name": "Galaxy Training Network",
    "url": "https://galaxyproject.org/teach/gtn/"
  },
  "sourceOrganization": {
    "@type": "Organization",
    "email": "galaxytrainingnetwork@gmail.com",
    "name": "Galaxy Training Network",
    "url": "https://galaxyproject.org/teach/gtn/"
  },
  "isPartOf": {
    "@type": "CreativeWork",
    "name": "Galaxy Server administration",
    "description": "Resources related to configuration and maintenance of Galaxy servers",
    "url": "https://training.galaxyproject.org//training-material/topics/admin/"
  },
  "courseCode": "admin / ansible / hands-on",
  "learningResourceType": "hands-on tutorial",
  "name": "Hands-on for 'Ansible' tutorial",
  "url": "https://training.galaxyproject.org//training-material/topics/admin/tutorials/ansible/tutorial.html",
  "timeRequired": "PT60M",
  "description": "The questions this  addresses are:\n - Why Ansible?\n - How and when to use Ansible?\n - How to write a role?\n - How to leverage community build roles?\n\n\\nThe objectives are:\n - Learn Ansible basics\n - Write a simple role\n - Install a role from Ansible Galaxy\n\n",
  "inLanguage": {
    "@type": "Language",
    "name": "English",
    "alternateName": "en"
  },
  "hasPart": [

  ],
  "author": [
    {
      "@type": "Person",
      "name": "Helena Rasche"
    },
    {
      "@type": "Person",
      "name": "Saskia Hiltemann"
    }
  ],
  "contributor": [
    {
      "@type": "Person",
      "name": "Helena Rasche"
    },
    {
      "@type": "Person",
      "name": "Saskia Hiltemann"
    }
  ],
  "about": [
    {
      "@type": "CreativeWork",
      "name": "Galaxy Server administration",
      "description": "Resources related to configuration and maintenance of Galaxy servers",
      "url": "https://training.galaxyproject.org//training-material/topics/admin/"
    }
  ]
}
</script>

<section class="tutorial topic-admin">
    <h1 data-toc-skip>Ansible</h1>
    


    <div class="contributors-line">Authors: 
<a href="/training-material/hall-of-fame/hexylena/" class="contributor-badge contributor-hexylena"><img src="https://avatars.githubusercontent.com/hexylena?s=27" alt="Avatar">Helena Rasche</a>


<a href="/training-material/hall-of-fame/shiltemann/" class="contributor-badge contributor-shiltemann"><img src="https://avatars.githubusercontent.com/shiltemann?s=27" alt="Avatar">Saskia Hiltemann</a>


<a href="https://training.galaxyproject.org/training-material/topics/contributing/" class="contributor-badge contributor-newcontributors"><i class="fas fa-users" aria-hidden="true"></i><span class="visually-hidden">hall-of-fame</span>Add Contributions!</a>

</div>


    <blockquote class="overview">
        <h3>Overview</h3>
        
        <img alt="Creative Commons License" class="float-right" style="border-width:0; display: inline-block; margin:0" src="https://i.creativecommons.org/l/by/4.0/88x31.png" aria-hidden="true" />
        
        <strong><i class="far fa-question-circle" aria-hidden="true"></i> Questions:</strong>
        <ul>
        
        <li><p>Why Ansible?</p>
</li>
        
        <li><p>How and when to use Ansible?</p>
</li>
        
        <li><p>How to write a role?</p>
</li>
        
        <li><p>How to leverage community build roles?</p>
</li>
        
        </ul>

        <strong><i class="fas fa-bullseye" aria-hidden="true"></i> Objectives: </strong>
        <ul>
        
        <li><p>Learn Ansible basics</p>
</li>
        
        <li><p>Write a simple role</p>
</li>
        
        <li><p>Install a role from Ansible Galaxy</p>
</li>
        
        </ul>

        

        
        <div><strong><i class="fas fa-hourglass-half" aria-hidden="true"></i> Time estimation:</strong> 60 minutes</div>
        

        

        
        

        
        <div id="supporting-materials"><strong><i class="fa fa-external-link" aria-hidden="true"></i> Supporting Materials:</strong></div>
        <ul class="supporting_material">
            
                <li class="btn btn-default"><a href="/training-material/topics/admin/tutorials/ansible/slides.html" title="Slides for this tutorial">
                    <i class="fab fa-slideshare" aria-hidden="true"></i> Slides
                </a></li>
            

            

            

            

            

            
            
            

            <!-- Check the GTN Video Library for recordings of this tutorial or associated slides -->
            











  
  <li class="btn btn-default supporting_material">
    <a href="#" class="btn btn-default dropdown-toggle topic-icon" data-toggle="dropdown" aria-expanded="false" title="Latest recordings of this tutorial in the GTN Video Library">
        <i class="fas fa-video" aria-hidden="true"></i><span class="visually-hidden">video</span> Recordings
    </a>
    <ul class="dropdown-menu">
        
        

        
        
        

        <li>
            <a class="dropdown-item" href="https://gallantries.github.io/video-library/videos/admin/ansible/tutorial" title="View GTN Video Library for this Tutorial">
                <i class="fas fa-video" aria-hidden="true"></i><span class="visually-hidden">video</span> Tutorial (February 2021)
            </a>
        </li>
        
        
          
          
          

        <li>
            <a class="dropdown-item" href="https://gallantries.github.io/video-library/videos/admin/ansible/slides" title="View GTN Video Library for these Slides">
                <i class="fas fa-video" aria-hidden="true"></i><span class="visually-hidden">video</span> Lecture (February 2021)
            </a>
        </li>
        
        
    </ul>
   </li>
   



            
        </ul>
        

        <div><strong><i class="far fa-calendar" aria-hidden="true"></i> Last modification:</strong> Jul 9, 2021 </div>
        <div><strong><i class="fas fa-balance-scale" aria-hidden="true"></i> License:</strong>
            
            <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">Tutorial Content is licensed under Creative Commons Attribution 4.0 International License</a>
            
            <a rel="license" href="https://github.com/galaxyproject/training-material/blob/main/LICENSE.md">The GTN Framework is licensed under MIT</a>
        </div>
    </blockquote>

    <div class="container">
        <div class="row">
            <!-- sidebar, which will move to the top on a small screen -->
            <div class="col-sm-2">
                <nav id="toc" data-toggle="toc" class="sticky-top" aria-label="Table of Contents"></nav>
            </div>
            <div class="col-sm-10">
                 

                <h1 class="no_toc" id="overview">Overview</h1>

<p>In this tutorial we will briefly cover what Ansible is and how to understand what it does. This guide is not meant to make you an expert on Ansible, but perhaps give you enough that you can debug broken roles and modify them to suit your needs. Or maybe to contribute to the <a href="https://github.com/galaxyproject?q=ansible"><span class="notranslate">Galaxy</span>project Ansible roles</a>.</p>

<p>This will be a very practical training with emphasis on looking at examples from modules and becoming self sufficient.</p>

<blockquote class="agenda">
  <h3 id="agenda">Agenda</h3>

<ol id="markdown-toc">
  <li><a href="#what-is-ansible" id="markdown-toc-what-is-ansible">What is Ansible?</a>    <ol>
      <li><a href="#inventory-file" id="markdown-toc-inventory-file">Inventory file</a></li>
      <li><a href="#roles" id="markdown-toc-roles">Roles</a></li>
      <li><a href="#modules-and-tasks" id="markdown-toc-modules-and-tasks">Modules and Tasks</a></li>
      <li><a href="#playbooks" id="markdown-toc-playbooks">Playbooks</a></li>
      <li><a href="#variables" id="markdown-toc-variables">Variables</a></li>
      <li><a href="#vaults" id="markdown-toc-vaults">Vaults</a></li>
    </ol>
  </li>
  <li><a href="#your-first-playbook-and-first-role" id="markdown-toc-your-first-playbook-and-first-role">Your First Playbook and First Role</a>    <ol>
      <li><a href="#a-basic-role" id="markdown-toc-a-basic-role">A Basic Role</a></li>
      <li><a href="#facts" id="markdown-toc-facts">Facts</a></li>
      <li><a href="#templates" id="markdown-toc-templates">Templates</a></li>
    </ol>
  </li>
  <li><a href="#ansible-galaxy" id="markdown-toc-ansible-galaxy">Ansible <span class="notranslate">Galaxy</span></a>    <ol>
      <li><a href="#choosing-a-role" id="markdown-toc-choosing-a-role">Choosing a Role</a></li>
    </ol>
  </li>
  <li><a href="#ansible-vault" id="markdown-toc-ansible-vault">Ansible Vault</a></li>
  <li><a href="#other-stuff" id="markdown-toc-other-stuff">Other Stuff</a>    <ol>
      <li><a href="#with-items" id="markdown-toc-with-items">With Items</a></li>
      <li><a href="#when-changed" id="markdown-toc-when-changed">When Changed</a></li>
      <li><a href="#notifying-handlers" id="markdown-toc-notifying-handlers">Notifying Handlers</a></li>
    </ol>
  </li>
</ol>

</blockquote>

<!--SNIPPET-->
<blockquote class="tip">  <h3 data-toc-skip="" id="-tip-operating-system-compatibility"><i class="far fa-lightbulb" aria-hidden="true"></i><span class="visually-hidden"></span> Tip: Operating system compatibility</h3>  <p>These Ansible roles and training materials were last tested on Centos 7 and Ubuntu 18.04, but will probably work on other RHEL and Debian variants.</p>  <p>The roles that are used in these training are currently used by <code class="language-plaintext highlighter-rouge">use<span class="notranslate">galaxy</span>.*</code>, and other, servers in maintaining their infrastructure. (<a href="https://github.com/galaxyproject/infrastructure-playbook/">US</a>, <a href="https://github.com/usegalaxy-eu/infrastructure-playbook">EU</a>, both are running CentOS 7)</p>  <p>If you have an issue running these trainings on your OS flavour, please report <a href="https://github.com/galaxyproject/training-material/issues/new">the issue</a> in the training material and we can see if it is possible to solve.</p></blockquote>

<h1 id="what-is-ansible">What is Ansible?</h1>

<p>Ansible runs commands on local or remote computers. It can move files around, create files from templates, and run command line tools. Primarily used for system administration tasks at scale. It has a push model rather than a pull model like Puppet. If you‚Äôve used Puppet, Ansible doesn‚Äôt evaluate what changes need to be made and make those, it just runs through all of commands every time.</p>

<p>Some terms that you should know first:</p>

<dl>
  <dt>Inventory file</dt>
  <dd>An Ansible-specific file that defines the systems (‚Äúhosts‚Äù) and groups of hosts on which Ansible should operate.</dd>
  <dt>Ansible module</dt>
  <dd>A piece of Python code that converts some parameters into an invocation. An example would be the <code class="language-plaintext highlighter-rouge">command</code> module which converts parameters like <code class="language-plaintext highlighter-rouge">command: ls</code> into a command line that is executed. There are pre-built modules for just about everything.</dd>
  <dt>Task</dt>
  <dd>A call to an Ansible module that should be executed and the configuration for this module.</dd>
  <dt>Role</dt>
  <dd>A folder containing some tasks, templates, files, and default values for variables, with a predefined directory structure. People share roles on <a href="https://galaxy.ansible.com/">‚ÄúAnsible <span class="notranslate">Galaxy</span>‚Äù</a>.</dd>
  <dt>Playbook</dt>
  <dd>A YAML file listing a set of tasks and/or roles that should be applied to a group of hosts.</dd>
  <dt>Vault</dt>
  <dd>An encrypted YAML file. You put your secrets here and then you can use them in tasks, roles and playbooks.</dd>
</dl>

<p>Looking at each of these briefly:</p>

<h2 id="inventory-file">Inventory file</h2>

<div class="language-ini highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">[webservers]</span>
<span class="err">192.0.2.0</span>
<span class="err">192.0.2.1</span>

<span class="nn">[databases]</span>
<span class="err">192.0.2.3</span> <span class="py">ansible_user</span><span class="p">=</span><span class="s">root</span>
</code></pre></div></div>

<p>Here we‚Äôve defined two groups of computers, <code class="language-plaintext highlighter-rouge">webservers</code> and <code class="language-plaintext highlighter-rouge">databases</code>. <code class="language-plaintext highlighter-rouge">ansible_user</code> is used to
specify which user to connect with (you need to specify that if you SSH in with a use<span class="notranslate">rna</span>me different
than your current local user account‚Äôs name).</p>

<p>As you can see, in this inventory we connect to multiple remote machines. This is common practice;
Ansible playbooks are stored on your laptop or a build server, and from there Ansible connects out to the
remote machines that are managed. The advantage of running remotely is that you can manage dozens of
machines simultaneously, rather than just the local machine. This scaling out to N machines is one of
the strengths of Ansible.</p>

<p>Additionally, playbooks are often stored in Git or other version control repositories to ensure that
if anything happens to the infrastructure you manage, you‚Äôll still have a copy of the information
required to rebuild everything with Ansible.</p>

<blockquote class="details">
  <h3 id="details-ansible-inventory-documentation-do-you-connect-with-a-different-user-password-ssh-key"><i class="fas fa-info-circle" aria-hidden="true"></i><span class="visually-hidden">details</span> Ansible Inventory Documentation (Do you connect with a different user? Password? SSH key?)</h3>
  <p>For more advanced features of the inventory file, check out <a href="https://docs.ansible.com/ansible/2.9/user_guide/intro_inventory.html">the official documentation on this topic</a>.</p>
</blockquote>

<h2 id="roles">Roles</h2>

<p>We can look at the <a href="https://github.com/galaxyproject/ansible-cvmfs">ansible-cvmfs role</a> as an example for the layout of a role:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>‚îú‚îÄ‚îÄ defaults
‚îÇ   ‚îî‚îÄ‚îÄ main.yml
‚îú‚îÄ‚îÄ files
‚îÇ   ‚îú‚îÄ‚îÄ cvmfs_remount_sync.c
‚îÇ   ‚îú‚îÄ‚îÄ cvmfs_remount_sync.centos_6
‚îÇ   ‚îú‚îÄ‚îÄ cvmfs_remount_sync.centos_7
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îú‚îÄ‚îÄ handlers
‚îÇ   ‚îî‚îÄ‚îÄ main.yml
‚îú‚îÄ‚îÄ meta
‚îÇ   ‚îî‚îÄ‚îÄ main.yml
‚îú‚îÄ‚îÄ tasks
‚îÇ   ‚îú‚îÄ‚îÄ apache.yml
‚îÇ   ‚îú‚îÄ‚îÄ ...
‚îÇ   ‚îú‚îÄ‚îÄ main.yml
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îú‚îÄ‚îÄ templates
‚îÇ   ‚îú‚îÄ‚îÄ ...
‚îÇ   ‚îî‚îÄ‚îÄ stratum1_squid.conf.j2
‚îî‚îÄ‚îÄ vars
    ‚îú‚îÄ‚îÄ ...
    ‚îú‚îÄ‚îÄ main.yml
    ‚îî‚îÄ‚îÄ ...
</code></pre></div></div>

<p>These are the folders that are included in many complex roles. Simpler roles will often not need all of the folders.</p>

<table>
  <thead>
    <tr>
      <th>Folder</th>
      <th>Usage</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>defaults</td>
      <td>Default values for variables the user can set (e.g. ‚Äúversion of software to install‚Äù).</td>
    </tr>
    <tr>
      <td>files</td>
      <td>These are files which should be copied as-is over to the remote location.</td>
    </tr>
    <tr>
      <td>handlers</td>
      <td>This is typically used for restarting processes.</td>
    </tr>
    <tr>
      <td>meta</td>
      <td>Only needed to publish your role to Ansible <span class="notranslate">Galaxy</span>.</td>
    </tr>
    <tr>
      <td>tasks</td>
      <td><strong>Always start reading here</strong>. This is the most important folder and the best place to start when trying to understand what an unfamiliar role does. Anything that is loaded will be referenced here (e.g. variables to load, handlers, files, templates).</td>
    </tr>
    <tr>
      <td>templates</td>
      <td>Files that are templated out with variables before being copied.</td>
    </tr>
    <tr>
      <td>vars</td>
      <td>Default values for variables the user should normally not change (e.g. name of a package in different Linux distributions).</td>
    </tr>
  </tbody>
</table>

<blockquote class="details">
  <h3 id="details-ansible-role-documentation"><i class="fas fa-info-circle" aria-hidden="true"></i><span class="visually-hidden">details</span> Ansible Role Documentation</h3>

  <p>For more information check out <a href="https://docs.ansible.com/ansible/2.9/user_guide/playbooks_reuse_roles.html">the official documentation on this topic</a>.</p>
</blockquote>

<h2 id="modules-and-tasks">Modules and Tasks</h2>

<p>A <code class="language-plaintext highlighter-rouge">tasks/main.yml</code> file calls multiple Ansible modules to accomplish its goal. A typical tasks file looks like:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">---</span>
<span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Download cvmfs_preload utility when desired</span>
  <span class="na">get_url</span><span class="pi">:</span>
    <span class="na">url</span><span class="pi">:</span> <span class="s">https://cvmrepo.web.cern.ch/cvmrepo/preload/cvmfs_preload</span>
    <span class="na">dest</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">cvmfs_preload_path</span><span class="nv"> </span><span class="s">}}/cvmfs_preload"</span>
    <span class="na">owner</span><span class="pi">:</span> <span class="s">root</span>
    <span class="na">group</span><span class="pi">:</span> <span class="s">root</span>
    <span class="na">mode</span><span class="pi">:</span> <span class="m">755</span>
  <span class="na">when</span><span class="pi">:</span> <span class="s">cvmfs_preload_install | bool</span>

<span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Ensure AutoFS is enabled + running</span>
  <span class="na">service</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">autofs</span>
    <span class="na">enabled</span><span class="pi">:</span> <span class="s">yes</span>
    <span class="na">state</span><span class="pi">:</span> <span class="s">started</span>
</code></pre></div></div>

<p>Here we have two tasks. Each has a <code class="language-plaintext highlighter-rouge">name</code> that will be shown to the person running the playbook.</p>

<p>The first example invokes the <a href="https://docs.ansible.com/ansible/2.9/modules/get_url_module.html"><code class="language-plaintext highlighter-rouge">get_url</code></a> module with 5 arguments (<code class="language-plaintext highlighter-rouge">url</code>, <code class="language-plaintext highlighter-rouge">dest</code>, <code class="language-plaintext highlighter-rouge">owner</code>, <code class="language-plaintext highlighter-rouge">group</code> and <code class="language-plaintext highlighter-rouge">mode</code>). This will download a file from the location indicated in <code class="language-plaintext highlighter-rouge">url</code> to the directory specified by <code class="language-plaintext highlighter-rouge">dest</code>, change user and group ownerships to <code class="language-plaintext highlighter-rouge">root</code>, and change file permissions to <code class="language-plaintext highlighter-rouge">755</code> (as assigned by the <code class="language-plaintext highlighter-rouge">mode</code> argument). The <code class="language-plaintext highlighter-rouge">dest</code> parameter uses a <a href="http://jinja.pocoo.org/">Jinja2</a> template to evaluate the value of the variable <code class="language-plaintext highlighter-rouge">cvmfs_preload_path</code>. We can <a href="https://github.com/galaxyproject/ansible-cvmfs/search?q=cvmfs_preload_path">grep through</a> the repository and see that <code class="language-plaintext highlighter-rouge">defaults/main.yml</code> sets that to <code class="language-plaintext highlighter-rouge">/usr/bin</code> by default. We can override this if we need, we‚Äôll come back to that later. The first task also has a <code class="language-plaintext highlighter-rouge">when</code> condition to ensure it only runs when the <code class="language-plaintext highlighter-rouge">cvmfs_preload_install</code> variable is set.</p>

<p>The second invokes the <a href="https://docs.ansible.com/ansible/2.9/modules/service_module.html"><code class="language-plaintext highlighter-rouge">service</code></a> module. The arguments to this one are quite legible and the functionality can be inferred from the names for the most part: The service <code class="language-plaintext highlighter-rouge">name: autofs</code> will be <code class="language-plaintext highlighter-rouge">enabled</code> and its <code class="language-plaintext highlighter-rouge">state</code> should be <code class="language-plaintext highlighter-rouge">started</code>.</p>

<p><a href="https://docs.ansible.com/ansible/2.9/modules/modules_by_category.html">Many modules</a> are available for you to use.</p>

<h3 id="stylistic-choices">Stylistic Choices</h3>

<p>Ansible accepts two ways to format tasks:</p>

<p>YAML style:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="pi">-</span> <span class="na">package</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">package_name</span><span class="nv"> </span><span class="s">}}"</span>
    <span class="na">state</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">package_state</span><span class="nv"> </span><span class="s">}}"</span>
</code></pre></div></div>

<p>And an inline style.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="pi">-</span> <span class="s">package name={{ package_name }} state={{ package_state }}</span>
</code></pre></div></div>

<p>Some groups prefer one style or another. You can mix both of these but you probably shouldn‚Äôt. In the YAML style the templated value needs to be quoted if the value after the colon starts with a <code class="language-plaintext highlighter-rouge">{</code> (see https://docs.ansible.com/ansible/latest/user_guide/playbooks_variables.html#when-to-quote-variables-a-yaml-gotcha ). The inline style does not require quoting of templated values.</p>

<h2 id="playbooks">Playbooks</h2>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">CVMFS</span>
  <span class="na">hosts</span><span class="pi">:</span> <span class="s">webservers</span>
  <span class="na">vars</span><span class="pi">:</span>
    <span class="na">cvmfs_numfiles</span><span class="pi">:</span> <span class="m">4096</span>
  <span class="na">roles</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s"><span class="notranslate">galaxy</span>project.cvmfs</span>
</code></pre></div></div>

<p>This is a quite minimal playbook. It selects a <code class="language-plaintext highlighter-rouge">hosts</code> group named <code class="language-plaintext highlighter-rouge">webservers</code>, overrides the variable <code class="language-plaintext highlighter-rouge">cvmfs_numfiles</code>, and then says the following set of roles will be executed for this group of hosts. Ansible makes it easy to collect tasks that should apply to a group of hosts and run a playbook for all of those hosts. Some good uses of this are things like ensuring a certain set of users are installed on all of your managed machines, or using one of the package autoupdating roles to make sure your machines are up-to-date.</p>

<blockquote class="details">
  <h3 id="details-ansible-playbook-documentation"><i class="fas fa-info-circle" aria-hidden="true"></i><span class="visually-hidden">details</span> Ansible Playbook Documentation</h3>

  <p>For more information check out <a href="https://docs.ansible.com/ansible/2.9/user_guide/playbooks_intro.html">the official documentation on this topic</a>.</p>
</blockquote>

<h3 id="philosophies">Philosophies</h3>

<p>Different groups use playbooks differently. Here is a non-exhaustive list of ways that the author has seen playbooks used:</p>

<table>
  <thead>
    <tr>
      <th>Strategy</th>
      <th>Use Cases</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>A single playbook that does everything</td>
      <td>Works well in cloud use cases where you would rather terminate a VM and just restart from nothing. If 100% of the tasks are idempotent (can be re-run without causing problems) then this can also work well for ensuring all machines that are managed are meeting your compliance standards.</td>
    </tr>
    <tr>
      <td>Playbooks that execute one-off commands</td>
      <td>Works well when you have commands that cannot safely be re-run (e.g. you are managing a repository on a remote machine and executing a ‚Äòcommit‚Äô action.) Also works if you have multiple people who are responsible for managing a machine but you want to ensure exactly the same commands are run each time a task needs to be done, with no variation.</td>
    </tr>
  </tbody>
</table>

<h2 id="variables">Variables</h2>

<p>There are a bunch of places variables can be set. <a href="https://docs.ansible.com/ansible/2.9/user_guide/playbooks_variables.html#variable-precedence-where-should-i-put-a-variable">The list is ridiculous.</a> Try and find a convention within your group and stick to that to help manage the chaos.</p>

<p>There are some special places you can put variables that will be loaded automatically:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">group_vars/&lt;group_name&gt;.yml</code>: if you run a playbook which has <code class="language-plaintext highlighter-rouge">hosts: webservers</code>, and <code class="language-plaintext highlighter-rouge">group_vars/webservers.yml</code> exists, it will be loaded.</li>
  <li><code class="language-plaintext highlighter-rouge">host_vars/&lt;host_name&gt;.yml</code>: if you run a playbook and it affects host (e.g.) <code class="language-plaintext highlighter-rouge">api01</code>, and <code class="language-plaintext highlighter-rouge">host_vars/api01.yml</code> exists, it will be loaded automatically.</li>
</ul>

<p>For a real-life example, Use<span class="notranslate">Galaxy</span>.eu <a href="https://github.com/usegalaxy-eu/infrastructure-playbook">generally attempts</a> to put variables in an appropriately named <code class="language-plaintext highlighter-rouge">group_vars/</code> file.</p>

<h2 id="vaults">Vaults</h2>

<p><a href="https://docs.ansible.com/ansible/2.9/user_guide/vault.html"><code class="language-plaintext highlighter-rouge">ansible-vault</code></a> is a super useful tool that lets you encrypt secrets for your group using a pre-shared key. This allows you to commit ALL of your Ansible playbooks and variables to source control, without the concern of leaking secrets. E.g. <a href="https://github.com/usegalaxy-eu/infrastructure-playbook/blob/master/secret_group_vars/all.yml">Use<span class="notranslate">Galaxy</span>.eu</a>‚Äôs vault file. The encrypted version is not very interesting to look at, but it is mostly to show that we confidently place an encrypted copy of our secrets online, under configuration management. This has made our life a lot easier.</p>

<h1 id="your-first-playbook-and-first-role">Your First Playbook and First Role</h1>

<p>The above introduction was certainly not enough for you to feel confident in Ansible, so we will now build a small role and a playbook to run this role.</p>

<blockquote class="warning">
  <h3 id="warning-safety-first"><i class="fas fa-exclamation-triangle" aria-hidden="true"></i><span class="visually-hidden">warning</span> Safety First</h3>

  <p>Many of the things you can do with Ansible can be quite dangerous. As dangerous as normally being at the command line, but scaled across N machines. Be very careful with the changes you plan to make.
Ansible provides some flags which can help you identify changes before they‚Äôre made to production systems:</p>

  <dl>
    <dt><strong><code class="language-plaintext highlighter-rouge">--diff</code></strong></dt>
    <dd>This will show the difference whenever a file is changed.</dd>
    <dt><strong><code class="language-plaintext highlighter-rouge">--check</code></strong></dt>
    <dd>Will do a dry-run of the playbook, attempting to show you which tasks will execute, which files will be updated. Not all actions can be predicted because commands are not run, if a <span class="notranslate">downstream</span> task depends on the result of a command execution task, Ansible has no way of knowing whether or not it will execute.</dd>
  </dl>

  <p>In this tutorial we will write to files in <code class="language-plaintext highlighter-rouge">/tmp</code> as that is a <em>relatively</em> safe thing to do. The training material community does not have the resources to test this tutorial across all of the platforms you might want to run it on. Additionally we do not want to be responsible if you accidentally cause permanent damage by following this tutorial.</p>

</blockquote>

<blockquote class="comment">
  <h3 id="comment-requirements-for-running-this-tutorial"><i class="far fa-comment-dots" aria-hidden="true"></i><span class="visually-hidden">comment</span> Requirements for Running This Tutorial</h3>

  <ol>
    <li>
      <p>You have <a href="https://docs.ansible.com/ansible/2.9/installation_guide/intro_installation.html">Ansible installed</a> on the machine where you will install <span class="notranslate">Galaxy</span></p>

      <blockquote class="comment">
        <h3 id="comment-comment-running-ansible-on-remote-machine"><i class="far fa-comment-dots" aria-hidden="true"></i><span class="visually-hidden">comment</span> Comment: Running Ansible on remote machine</h3>
        <p>It is possible to have Ansible installed on your laptop/local machine and run it against some remote hosts as well. We will <strong>not</strong> do that in this training.</p>
      </blockquote>
    </li>
    <li>
      <p>Your <code class="language-plaintext highlighter-rouge">ansible</code> version is <code class="language-plaintext highlighter-rouge">&gt;=2.7</code>, you can check this by running <code class="language-plaintext highlighter-rouge">ansible --version</code></p>
    </li>
  </ol>

</blockquote>

<h2 id="a-basic-role">A Basic Role</h2>

<blockquote class="notranslate hands_on">
  <h3 id="hands_on-hands-on-setting-up-our-workspace"><i class="fas fa-pencil-alt" aria-hidden="true"></i><span class="visually-hidden">hands_on</span> Hands-on: Setting up our workspace</h3>

  <ol>
    <li>
      <p>In this training we will run Ansible on the machine it will modify. This is not best practice, but it is convenient for trainings. You should probably run this in a VM either on the Cloud or in VirtualBox or similar</p>

      <p>All of the steps are the same, no matter which machine Ansible will manage and where you run it. The only difference is the connection setup</p>
    </li>
    <li>
      <p><strong>Create a directory named <code class="language-plaintext highlighter-rouge">intro</code> and <code class="language-plaintext highlighter-rouge">cd</code> into it.</strong></p>

      <p>It‚Äôs good practice to keep your deployments separated, and later on we‚Äôll be deploying <span class="notranslate">Galaxy</span> with ansible in a separate directory.</p>
    </li>
    <li>
      <p>Create your inventory file (named <code class="language-plaintext highlighter-rouge">hosts</code>) in this folder</p>

      <ol>
        <li>
          <p>We will call our group <code class="language-plaintext highlighter-rouge">my_hosts</code></p>
        </li>
        <li>
          <p>Create <a href="https://docs.ansible.com/ansible/2.9/user_guide/intro_inventory.html">an inventory file</a> with the group <code class="language-plaintext highlighter-rouge">my_hosts</code> and <code class="language-plaintext highlighter-rouge">localhost ansible_connection=local</code>, which tells Ansible to not use SSH, and just use the local connection. Additionally, you should explicitly set the <code class="language-plaintext highlighter-rouge">ansible_user</code> variable to the use<span class="notranslate">rna</span>me to use when connecting to the server. Ansible has changed its behaviour over time regarding whether or not <code class="language-plaintext highlighter-rouge">ansible_user</code> is defined, and it is most effective to define it explicitly even when it can sometimes be inferred.</p>

          <blockquote class="solution">
            <h3 id="solution-solution"><i class="far fa-eye" aria-hidden="true"></i><span class="visually-hidden">solution</span> Solution</h3>
            <p>The file should look like:</p>

            <div class="language-ini highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">[my_hosts]</span>
<span class="err">localhost</span> <span class="py">ansible_connection</span><span class="p">=</span><span class="s">local ansible_user=ubuntu</span>
</code></pre></div>            </div>
          </blockquote>

          <blockquote class="details">
            <h3 id="details-for-your-own-infrastructure-do-you-connect-with-a-different-user-password-ssh-key"><i class="fas fa-info-circle" aria-hidden="true"></i><span class="visually-hidden">details</span> For your own infrastructure, do you connect with a different user? Password? SSH key?</h3>
            <p>For more advanced features of the inventory file, check out <a href="https://docs.ansible.com/ansible/2.9/user_guide/intro_inventory.html">the official documentation on this topic</a>.</p>
          </blockquote>
        </li>
      </ol>
    </li>
    <li>
      <p>Create the roles directory, your role, and the tasks folder: <code class="language-plaintext highlighter-rouge">mkdir -p roles/my-role/tasks/</code></p>
    </li>
    <li>
      <p>Create a YAML file in that directory, <code class="language-plaintext highlighter-rouge">roles/my-role/tasks/main.yml</code> and open it for editing</p>
    </li>
    <li>
      <p>Define a <code class="language-plaintext highlighter-rouge">copy</code> task like below:</p>

      <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">---</span>
<span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Copy a file to the remote host</span>
  <span class="na">copy</span><span class="pi">:</span>
    <span class="na">src</span><span class="pi">:</span> <span class="s">test.txt</span>
    <span class="na">dest</span><span class="pi">:</span> <span class="s">/tmp/test.txt</span>
</code></pre></div>      </div>

      <p>You can read about all of the parameters available to the <a href="http://docs.ansible.com/ansible/2.9/modules/copy_module.html"><code class="language-plaintext highlighter-rouge">copy</code></a> module in Ansible‚Äôs documentation.</p>

      <blockquote class="details">
        <h3 id="details-ansible-module-documentation"><i class="fas fa-info-circle" aria-hidden="true"></i><span class="visually-hidden">details</span> Ansible Module Documentation</h3>
        <p>You can usually find a module for most commands you will run in a shell, e.g. by searching the internet for ‚Äúansible copy file to server‚Äù or ‚Äúansible restart service‚Äù. If you cannot find a module that does it, there is the <a href="http://docs.ansible.com/ansible/2.9/modules/command_module.html"><code class="language-plaintext highlighter-rouge">command</code></a> module, but this should be avoided if possible. Expect to have a browser session with 10-30 different Ansible module documentation tabs if you work with Ansible regularly, no one remembers what arguments are available to every module.</p>

      </blockquote>
    </li>
    <li>
      <p>Create a <code class="language-plaintext highlighter-rouge">roles/my-role/files</code> folder, and within it a file named <code class="language-plaintext highlighter-rouge">test.txt</code>, containing the content ‚ÄúHello, <span class="notranslate">Galaxy</span> üöÄ‚Äù</p>
    </li>
    <li>
      <p>This is a complete role by itself and will copy the file <code class="language-plaintext highlighter-rouge">test.txt</code> from the <code class="language-plaintext highlighter-rouge">roles/my-role/files/</code> folder over to the target host and place it in <code class="language-plaintext highlighter-rouge">/tmp</code>.</p>
    </li>
    <li>
      <p>Create and open <code class="language-plaintext highlighter-rouge">playbook.yml</code> file for editing in the <code class="language-plaintext highlighter-rouge">intro</code> directory you created. Place the following content in there:</p>

      <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">---</span>
<span class="pi">-</span> <span class="na">hosts</span><span class="pi">:</span> <span class="s">my_hosts</span>
  <span class="na">roles</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">my-role</span>
</code></pre></div>      </div>

      <blockquote class="question">
        <h3 id="question-question"><i class="far fa-question-circle" aria-hidden="true"></i><span class="visually-hidden">question</span> Question</h3>

        <p>How does your file tree look now? Use <code class="language-plaintext highlighter-rouge">find</code> or <code class="language-plaintext highlighter-rouge">tree</code>.</p>

        <blockquote class="solution">
          <h3 id="solution-solution-1"><i class="far fa-eye" aria-hidden="true"></i><span class="visually-hidden">solution</span> Solution</h3>

          <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>.
‚îú‚îÄ‚îÄ hosts
‚îú‚îÄ‚îÄ playbook.yml
‚îî‚îÄ‚îÄ roles
    ‚îî‚îÄ‚îÄ my-role
        ‚îú‚îÄ‚îÄ files
        ‚îÇ¬†¬† ‚îî‚îÄ‚îÄ test.txt
        ‚îî‚îÄ‚îÄ tasks
            ‚îî‚îÄ‚îÄ main.yml
</code></pre></div>          </div>

        </blockquote>
      </blockquote>
    </li>
    <li>
      <p>Run the playbook:</p>

      <blockquote class="code-2col">
        <blockquote class="code-in">
          <h3 id="code-in-input-bash"><i class="far fa-keyboard" aria-hidden="true"></i><span class="visually-hidden">code-in</span> Input: Bash</h3>
          <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ansible-playbook <span class="nt">-i</span> hosts playbook.yml
</code></pre></div>          </div>
        </blockquote>

        <blockquote class="code-out">
          <h3 id="code-out-output-bash"><i class="fas fa-laptop-code" aria-hidden="true"></i><span class="visually-hidden">code-out</span> Output: Bash</h3>
          <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PLAY [my_hosts] ****************************************************************
TASK [Gathering Facts] *********************************************************
ok: [localhost]
TASK [my-role : Copy a file to the remote host] ********************************
changed: [localhost]
PLAY RECAP *********************************************************************
localhost                  : ok=2    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
</code></pre></div>          </div>
        </blockquote>
      </blockquote>
    </li>
    <li>
      <p>Login to the appropriate host (unless your host was <code class="language-plaintext highlighter-rouge">localhost</code>) and <code class="language-plaintext highlighter-rouge">cat /tmp/test.txt</code> to see that the change was made.</p>
    </li>
  </ol>

</blockquote>

<p>Now that you‚Äôve done this, here are some starting points for exploration:</p>

<ul>
  <li>Add more hosts, watch as Ansible executes over all of them in parallel.</li>
  <li>Identify a task you do regularly, e.g. restarting a service. Find the Ansible service module and add that to your playbook.</li>
</ul>

<blockquote class="comment">
  <h3 id="comment-too-many-cows"><i class="far fa-comment-dots" aria-hidden="true"></i><span class="visually-hidden">comment</span> Too Many Cows?</h3>
  <p>If you‚Äôve installed the <code class="language-plaintext highlighter-rouge">cowsay</code> tool, Ansible (for some reason) will take advantage of that to output a lot of the output with cowsay. To disable this you can <code class="language-plaintext highlighter-rouge">export ANSIBLE_NOCOWS=1</code> (Remember that exporting will only last as long as the current invocation of your terminal does, so consider adding this to your user profile if you wish to keep cowsay installed and still have legible output.)</p>

  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> ________________
&lt; PLAY [my_hosts] &gt;
 ----------------
        \   ^__^
         \  (oo)\_______
            (__)\       )\/\
                ||----w |
                ||     ||
 ________________________
&lt; TASK [Gathering Facts] &gt;
 ------------------------
        \   ^__^
         \  (oo)\_______
            (__)\       )\/\
                ||----w |
                ||     ||
</code></pre></div>  </div>
</blockquote>

<h2 id="facts">Facts</h2>

<p>In the last step of the last hands-on, you ran your playbook. The first <code class="language-plaintext highlighter-rouge">TASK</code> that was executed was not one that you had written, it <span class="notranslate">reads</span>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>TASK [Gathering Facts] *********************************************************
ok: [localhost]
</code></pre></div></div>

<p>The <a href="https://docs.ansible.com/ansible/2.9/modules/setup_module.html"><code class="language-plaintext highlighter-rouge">setup</code></a> module runs by default for every host and gathers facts about the host.</p>

<blockquote class="notranslate hands_on">
  <h3 id="hands_on-hands-on-the-setup-module"><i class="fas fa-pencil-alt" aria-hidden="true"></i><span class="visually-hidden">hands_on</span> Hands-on: The Setup Module</h3>

  <ol>
    <li>
      <p>Run the command <code class="language-plaintext highlighter-rouge">ansible -i hosts -m setup my_hosts | less</code>.</p>

      <p>The <code class="language-plaintext highlighter-rouge">my_hosts</code> at the end of the command refers to the group we defined in our <code class="language-plaintext highlighter-rouge">hosts</code> inventory file.</p>
    </li>
    <li>
      <p>Investigate the output. See what sort of information is made available to you.</p>

      <blockquote class="question">
        <h3 id="question-question-1"><i class="far fa-question-circle" aria-hidden="true"></i><span class="visually-hidden">question</span> Question</h3>

        <ol>
          <li>What variable stores the OS name?</li>
          <li>Where are all of the places that you can find your machine‚Äôs IP (v4) addresses?</li>
        </ol>

        <blockquote class="solution">
          <h3 id="solution-solution-2"><i class="far fa-eye" aria-hidden="true"></i><span class="visually-hidden">solution</span> Solution</h3>

          <ol>
            <li>
              <p>The OS name is stored in <code class="language-plaintext highlighter-rouge">ansible_distribution</code>. We saw <code class="language-plaintext highlighter-rouge">ansible_os_family</code> used above in the <code class="language-plaintext highlighter-rouge">ansible-cvmfs</code> role. You can use these variables if you are writing a generic role but packages or commands are named different on different operating systems.</p>
            </li>
            <li>
              <p>Ansible stores network information in quite a few places, sometimes one place is more convenient or more correct to use:</p>

              <ul>
                <li><code class="language-plaintext highlighter-rouge">ansible_all_ipv4_addresses</code></li>
                <li><code class="language-plaintext highlighter-rouge">ansible_default_ipv4.address</code></li>
                <li><code class="language-plaintext highlighter-rouge">ansible_&lt;interface_name&gt;.ipv4</code></li>
              </ul>
            </li>
          </ol>

        </blockquote>

      </blockquote>
    </li>
  </ol>

</blockquote>

<h2 id="templates">Templates</h2>

<p>Templates give you greater control over the files you are deploying to the target system. If you need to deploy a file to multiple hosts, but configure it differently on each host, you should use templates. For instance, deploying a service that should only listen on the correct IP address for that host would be a good use case for templates. All of the facts you discovered in the previous hands-on are available to you to use in templates, <code class="language-plaintext highlighter-rouge">when</code> statements (like the <a href="#modules-and-tasks">ansible-cvmfs example we saw earlier</a>). Additionally all of the variables you‚Äôve defined are available as well.</p>

<blockquote class="details">
  <h3 id="details-template-syntax"><i class="fas fa-info-circle" aria-hidden="true"></i><span class="visually-hidden">details</span> Template Syntax</h3>
  <p>Templates end with the <code class="language-plaintext highlighter-rouge">.j2</code> suffix and use Jinja2 syntax. If you are not familiar with it, you should <a href="http://jinja.pocoo.org/docs/2.10/templates/">read about it</a> first, before moving on with the tutorial. Ansible fills the templates with variable values and copies the file to its remote destination without the <code class="language-plaintext highlighter-rouge">.j2</code> suffix.</p>
</blockquote>

<blockquote class="notranslate hands_on">
  <h3 id="hands_on-hands-on-variables-and-templates"><i class="fas fa-pencil-alt" aria-hidden="true"></i><span class="visually-hidden">hands_on</span> Hands-on: Variables and Templates</h3>

  <ol>
    <li>
      <p>Create the directories: <code class="language-plaintext highlighter-rouge">roles/my-role/templates</code>, <code class="language-plaintext highlighter-rouge">roles/my-role/defaults</code></p>
    </li>
    <li>
      <p>Create and edit a file for your role‚Äôs variables, <code class="language-plaintext highlighter-rouge">roles/my-role/defaults/main.yml</code></p>
    </li>
    <li>
      <p>Insert the following content:</p>

      <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">---</span>
<span class="na">server_name</span><span class="pi">:</span> <span class="s">Cats!</span>
</code></pre></div>      </div>

      <p>This will define a variable <code class="language-plaintext highlighter-rouge">server_name</code> that can then be used in templates.</p>
    </li>
    <li>
      <p>Create and edit <code class="language-plaintext highlighter-rouge">roles/my-role/templates/test.ini.j2</code></p>
    </li>
    <li>
      <p>Insert the following content:</p>

      <div class="language-ini highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">[example]</span>
<span class="py">server_name</span> <span class="p">=</span> <span class="s">{{ server_name }}</span>
<span class="py">listen</span> <span class="p">=</span> <span class="s">{{ ansible_default_ipv4.address }}</span>
</code></pre></div>      </div>
    </li>
    <li>
      <p>Edit <code class="language-plaintext highlighter-rouge">roles/my-role/tasks/main.yml</code> and append a new task to the end to template this file:</p>

      <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Template the configuration file</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">src</span><span class="pi">:</span> <span class="s">test.ini.j2</span>
    <span class="na">dest</span><span class="pi">:</span> <span class="s">/tmp/test.ini</span>
</code></pre></div>      </div>
    </li>
    <li>
      <p>Run the playbook again.</p>
    </li>
    <li>
      <p>Check the contents of <code class="language-plaintext highlighter-rouge">/tmp/test.ini</code></p>

      <blockquote class="code-2col">
        <blockquote class="code-in">
          <h3 id="code-in-input-bash-1"><i class="far fa-keyboard" aria-hidden="true"></i><span class="visually-hidden">code-in</span> Input: Bash</h3>
          <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cat</span> /tmp/test.ini
</code></pre></div>          </div>
        </blockquote>

        <blockquote class="code-out">
          <h3 id="code-out-output"><i class="fas fa-laptop-code" aria-hidden="true"></i><span class="visually-hidden">code-out</span> Output</h3>

          <p>The file should look like:</p>
          <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[example]
server_name = Cats!
listen = 192.168.0.2
</code></pre></div>          </div>
          <p>Where the last line has the machine‚Äôs IP address.</p>
        </blockquote>
      </blockquote>

      <p>Now that this has worked successfully, we will setup a <code class="language-plaintext highlighter-rouge">group_vars</code> folder
to show how a person using <code class="language-plaintext highlighter-rouge">my-role</code> would override the <code class="language-plaintext highlighter-rouge">server_name</code> variable.</p>
    </li>
    <li>
      <p>Create the folder <code class="language-plaintext highlighter-rouge">group_vars/</code> (in the root of your directory)</p>
    </li>
    <li>
      <p>Create and edit <code class="language-plaintext highlighter-rouge">group_vars/my_hosts.yml</code></p>
    </li>
    <li>
      <p>Insert the following:</p>

      <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">---</span>
<span class="na">server_name</span><span class="pi">:</span> <span class="s">Dogs!</span>
</code></pre></div>      </div>

      <blockquote class="tip">
        <h3 id="tip-variable-connection"><i class="far fa-lightbulb" aria-hidden="true"></i><span class="visually-hidden">tip</span> Variable connection</h3>
        <p>When the playbook runs, as part of the setup, it collects any variables that are set. For a playbook affecting a group of hosts named <code class="language-plaintext highlighter-rouge">my_hosts</code>, it checks many different places for variables, including ‚Äúgroup_vars/my_hosts.yml‚Äù. If there are variables there, they‚Äôre added to the collection of current variables. It also checks ‚Äúgroup_vars/all.yml‚Äù (for the built-in host group <code class="language-plaintext highlighter-rouge">all</code>). There is a precedence order, but then these variables are available for roles and tasks to consume.</p>
      </blockquote>
    </li>
    <li>
      <p>Run the playbook again, but imagine you are worried about this change, and supply the <code class="language-plaintext highlighter-rouge">--check --diff</code> flag to see what changes are made before committing to make them.</p>

      <blockquote class="code-in">
        <h3 id="code-in-input-bash-2"><i class="far fa-keyboard" aria-hidden="true"></i><span class="visually-hidden">code-in</span> Input: Bash</h3>
        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ansible-playbook <span class="nt">-i</span> hosts playbook.yml <span class="nt">--check</span> <span class="nt">--diff</span>
</code></pre></div>        </div>
      </blockquote>

      <blockquote class="tip">
        <h3 id="tip-what-if-you-forget---diff"><i class="far fa-lightbulb" aria-hidden="true"></i><span class="visually-hidden">tip</span> What if you forget <code class="language-plaintext highlighter-rouge">--diff</code>?</h3>
        <p>If you forget to use <code class="language-plaintext highlighter-rouge">--diff</code>, it is not easy to see what has changed. Some modules like the <code class="language-plaintext highlighter-rouge">copy</code> and <code class="language-plaintext highlighter-rouge">template</code> modules have a <code class="language-plaintext highlighter-rouge">backup</code> option. If you set this option, then it will keep a backup copy next to the destination file.
However, most modules do not have such an option, so if you want to know what changes, always use <code class="language-plaintext highlighter-rouge">--diff</code>.</p>
      </blockquote>

      <blockquote class="code-out">
        <h3 id="code-out-output-1"><i class="fas fa-laptop-code" aria-hidden="true"></i><span class="visually-hidden">code-out</span> Output</h3>

        <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PLAY [my_hosts] ****************************************************************
TASK [Gathering Facts] *********************************************************
ok: [localhost]
TASK [my-role : Copy a file to the remote host] ********************************
ok: [localhost]
TASK [my-role : Template the configuration file] *******************************
--- before: /tmp/test.ini
+++ after: /home/hxr/.ansible/tmp/ansible-local-1906887dr2u6j8n/tmptx9pdelg/test.ini.j2
@@ -1,3 +1,3 @@
 [example]
-server_name = Cats!
+server_name = Dogs!
 listen = 192.168.0.25
changed: [localhost]
PLAY RECAP **********************************************
localhost                  : ok=3    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
</code></pre></div>        </div>
        <p>Here you can see that the <code class="language-plaintext highlighter-rouge">server_name</code> value will be changed. Despite Ansible reporting <code class="language-plaintext highlighter-rouge">changed=1</code>, no changes have actually been applied to the system.</p>
      </blockquote>
    </li>
    <li>
      <p>Run the playbook again, without the <code class="language-plaintext highlighter-rouge">--check</code> flag to apply your changes.</p>
    </li>
  </ol>
</blockquote>

<blockquote class="comment">
  <h3 id="comment-ansible-variable-templating"><i class="far fa-comment-dots" aria-hidden="true"></i><span class="visually-hidden">comment</span> Ansible Variable Templating</h3>
  <p>In this hands-on we used some templated variables. We defined them in a template, but they are also commonly used in the group variables file. Our templated variable looked like: <code class="language-plaintext highlighter-rouge">listen = {{ ansible_default_ipv4.address }}</code>.</p>

  <p>It is common to see things like this in Ansible roles:</p>

  <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s">root_dir = /opt/my-app</span>
<span class="s">config_dir = "{{ root_dir }}/config"</span>
</code></pre></div>  </div>

  <p>When Ansible runs:</p>

  <ol>
    <li>It collects variables defined in group variables and other places</li>
    <li>The first task for each machine is the <a href="https://docs.ansible.com/ansible/2.9/modules/setup_module.html"><code class="language-plaintext highlighter-rouge">setup</code> module</a> which gathers facts about the host, which are added to the available variables</li>
    <li>When multiple roles execute in a playbook:
      <ol>
        <li>Their defaults are added to the set of variables (the group variables having precedence over these variables)</li>
        <li>They can also dynamically define more variables which may not be set until that role is run</li>
      </ol>
    </li>
    <li>Before use (in templates, commands, etc.), variables are resolved to their final value</li>
  </ol>

</blockquote>

<h1 id="ansible-galaxy">Ansible <span class="notranslate">Galaxy</span></h1>

<p>Now that you‚Äôve built a small role, you can imagine that building real roles that manage the full installation of a piece of software are not simple things. Ansible <span class="notranslate">Galaxy</span> is the answer here. Many roles for common administration tasks, and software installation and setup are readily available on Ansible <span class="notranslate">Galaxy</span>.</p>

<p><strong>Warning</strong>: This will install Memcached on the target machine.</p>

<blockquote class="notranslate hands_on">
  <h3 id="hands_on-hands-on-installing-a-module-using-ansible-galaxy"><i class="fas fa-pencil-alt" aria-hidden="true"></i><span class="visually-hidden">hands_on</span> Hands-on: Installing a module using ansible-<span class="notranslate">galaxy</span></h3>

  <ol>
    <li>
      <p>Install the geerlingguy.memcached role with ansible-<span class="notranslate">galaxy</span> into your roles folder:</p>

      <blockquote class="code-2col">
        <blockquote class="code-in">
          <h3 id="code-in-input-bash-3"><i class="far fa-keyboard" aria-hidden="true"></i><span class="visually-hidden">code-in</span> Input: Bash</h3>
          <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ansible-<span class="notranslate">galaxy</span> <span class="nb">install</span> <span class="se">\</span>
    <span class="nt">-p</span> roles/ geerlingguy.memcached
</code></pre></div>          </div>
        </blockquote>

        <blockquote class="code-out">
          <h3 id="code-out-output-2"><i class="fas fa-laptop-code" aria-hidden="true"></i><span class="visually-hidden">code-out</span> Output</h3>
          <p>This will install the new role into your <code class="language-plaintext highlighter-rouge">roles</code> folder, alongside your own role.</p>
          <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>- downloading role 'memcached', owned by geerlingguy
- downloading role from https://github.com/geerlingguy/ansible-role-memcached/archive/1.1.0.tar.gz
- extracting geerlingguy.memcached to /home/ubuntu/ansible/intro/roles/geerlingguy.memcached
- geerlingguy.memcached (1.1.0) was installed successfully
</code></pre></div>          </div>
        </blockquote>
      </blockquote>
    </li>
    <li>
      <p>Edit your playbook.yml and add the role <code class="language-plaintext highlighter-rouge">geerlingguy.memcached</code> at the bottom, after <code class="language-plaintext highlighter-rouge">my-role</code></p>
    </li>
    <li>
      <p>Run the playbook</p>

      <blockquote class="question">
        <h3 id="question-question-2"><i class="far fa-question-circle" aria-hidden="true"></i><span class="visually-hidden">question</span> Question</h3>

        <p>Did something go wrong?</p>

        <blockquote class="solution">
          <h3 id="solution-solution-3"><i class="far fa-eye" aria-hidden="true"></i><span class="visually-hidden">solution</span> Solution</h3>

          <p>Since you have been running the playbook as a non-root user (or at least you should have been!), the step to install a package fails.
The solution to this is to set <code class="language-plaintext highlighter-rouge">become: true</code>.</p>

          <ol>
            <li>Edit your playbook.yml
              <ul>
                <li>add <code class="language-plaintext highlighter-rouge">become: true</code> just below <code class="language-plaintext highlighter-rouge">hosts: my_hosts</code></li>
              </ul>
            </li>
            <li>Run the playbook again</li>
          </ol>

          <p><code class="language-plaintext highlighter-rouge">become</code> causes Ansible to attempt to become a different user (using sudo/su/whatever is appropriate), by default this is <code class="language-plaintext highlighter-rouge">root</code>. If you want to become a different user, just set <code class="language-plaintext highlighter-rouge">become_user</code>. Beware, the user should be able to privilege escalate without a password prompt. Otherwise when you execute the playbook you should set <code class="language-plaintext highlighter-rouge">--ask-become-pass</code>, using the privilege escalation password for that host.</p>

          <blockquote class="details">
            <h3 id="details-ansible-become"><i class="fas fa-info-circle" aria-hidden="true"></i><span class="visually-hidden">details</span> Ansible Become</h3>
            <p>See the <a href="https://docs.ansible.com/ansible/2.9/user_guide/become.html">documentation</a> if you need to control this behaviour differently. <code class="language-plaintext highlighter-rouge">become</code> can be set either at the task level or the playbook level.</p>

          </blockquote>

          <blockquote class="tip">
            <h3 id="tip-should-i-use-sudo-or-directly-login-as-root"><i class="far fa-lightbulb" aria-hidden="true"></i><span class="visually-hidden">tip</span> Should I use sudo or directly login as root?</h3>
            <p>This is often site-specific policy. If your site doesn‚Äôt have a dictated policy, then it‚Äôs generally preferable to not allow direct login as root, and login as a separate user.</p>
          </blockquote>

        </blockquote>
      </blockquote>
    </li>
  </ol>

</blockquote>

<h2 id="choosing-a-role">Choosing a Role</h2>

<p>Picking the best role for a task from Ansible <span class="notranslate">Galaxy</span> is not always a trivial task. Sometimes there will only be a single role doing what you need. Other times you‚Äôll have to choose between 20 different roles that all look more or less the same. Here are some tips to guide you in identifying appropriate and well-written roles:</p>

<ul>
  <li>The name should match the software you are using (I.e. ignore a role named <code class="language-plaintext highlighter-rouge">stackstorm</code> when you are trying to set up <code class="language-plaintext highlighter-rouge">rabbitmq</code>. Ansible <span class="notranslate">Galaxy</span> does not have perfect search.)</li>
  <li><code class="language-plaintext highlighter-rouge">geerlingguy</code> wrote a huge number of roles for many pieces of standard software. If there is a role from this person, this is usually a safe choice. In the same way we recommend <code class="language-plaintext highlighter-rouge"><span class="notranslate">galaxy</span>project</code> and <code class="language-plaintext highlighter-rouge">use<span class="notranslate">galaxy</span>_eu</code> roles.</li>
  <li>Check the GitHub readme of each role you consider using. Look for:
    <ul>
      <li>Extensive documentation of all of the variables, their default values, and how they behave.</li>
      <li>An example playbook using the role</li>
    </ul>
  </li>
  <li>A large number of downloads is a good sign that other people found it useful</li>
</ul>

<p>These are usually good proxies for quality, but do not treat them as strict rules. For an example of a role meeting many of these qualities, <a href="https://github.com/galaxyproject/ansible-cvmfs"><code class="language-plaintext highlighter-rouge">ansible-cvmfs</code></a> is good; the variables are well documented and there are example playbooks that you can (more or less) copy-and-paste and run.</p>

<p>Sometimes a role will accomplish 95% of what you need to do, but not everything. Once you have installed the role with <code class="language-plaintext highlighter-rouge">ansible-<span class="notranslate">galaxy</span> install</code>, you can edit it locally to make any changes. In an ideal world you would contribute this back, but this is not always a high priority. Many projects copy roles directly into their repositories, e.g. <a href="https://github.com/galaxyproject/infrastructure-playbook/tree/master/roles"><span class="notranslate">galaxy</span>project</a> and <a href="https://github.com/usegalaxy-eu/infrastructure-playbook/tree/master/roles">use<span class="notranslate">galaxy</span>.eu</a></p>

<blockquote class="tip">
  <h3 id="tip-how-do-i-know-what-i-can-do-with-a-role-what-variables-are-available"><i class="far fa-lightbulb" aria-hidden="true"></i><span class="visually-hidden">tip</span> How do I know what I can do with a role? What variables are available?</h3>
  <p>You don‚Äôt. There is no standard way for reporting this, but well written roles by trusted authors (e.g. geerlingguy, <span class="notranslate">galaxy</span>project) do it properly and write all of the variables in the README file of the repository. We try to pick sensible roles for you in this course, but, in real life it may not be that simple.</p>

  <p>So, definitely check there first, but if they aren‚Äôt there, then you‚Äôll need to read through <code class="language-plaintext highlighter-rouge">defaults/</code> and <code class="language-plaintext highlighter-rouge">tasks/</code> and <code class="language-plaintext highlighter-rouge">templates/</code> to figure out what the role does and how you can control and modify it to accomplish your goals.</p>
</blockquote>

<h1 id="ansible-vault">Ansible Vault</h1>

<p>Now that you have a small role built up, you might start thinking about deploying larger and more complex services and infrastructure. One last common task we want to cover here is the inclusion of secrets. Ansible Vault is really useful to include encrypted secrets in your playbook repository.</p>

<blockquote class="notranslate hands_on">
  <h3 id="hands_on-hands-on-setting-up-secrets"><i class="fas fa-pencil-alt" aria-hidden="true"></i><span class="visually-hidden">hands_on</span> Hands-on: Setting up secrets</h3>

  <ol>
    <li>
      <p>Run <code class="language-plaintext highlighter-rouge">mkdir -p secret_group_vars</code></p>
    </li>
    <li>
      <p>Now we‚Äôll create a strong password: <code class="language-plaintext highlighter-rouge">openssl rand -base64 24 &gt; vault-password.txt</code></p>
    </li>
    <li>
      <p>Run <code class="language-plaintext highlighter-rouge">ansible-vault create secret_group_vars/all.yml --vault-password-file=vault-password.txt</code></p>

      <p>This will open <code class="language-plaintext highlighter-rouge">secret_group_vars/all.yml</code> in your text editor.</p>
    </li>
    <li>
      <p>In this file, enter the following contents and save it:</p>

      <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apikey</span><span class="pi">:</span> <span class="s">super-secret-api-key-wow!</span>
</code></pre></div>      </div>

      <blockquote class="question">
        <h3 id="question-question-3"><i class="far fa-question-circle" aria-hidden="true"></i><span class="visually-hidden">question</span> Question</h3>

        <p>How does your file look? Is it readable? Run <code class="language-plaintext highlighter-rouge">cat secret_group_vars/all.yml</code></p>

        <blockquote class="solution">
          <h3 id="solution-solution-4"><i class="far fa-eye" aria-hidden="true"></i><span class="visually-hidden">solution</span> Solution</h3>

          <p>The file will look like this, it is encrypted by Ansible Vault with AES256 encryption.</p>
          <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ cat secret_group_vars/all.yml
$ANSIBLE_VAULT;1.1;AES256
64373665366130333437393639343534653134346538636239393363373062393830653333323966
3134333366363130326139323162323131643763336236320a393262303938316262643764323862
36393161666663353231366336613838633866323230303031313465646333613862363264323139
3263383530626262370a666139666462663938343531656432353239346532316630366165376566
34313765353766666330366632303836353863396430343264303032363739666139383830323565
6133663637356331613062353834646561653366386665623930
</code></pre></div>          </div>

        </blockquote>
      </blockquote>
    </li>
    <li>
      <p>Use the new variable in our <code class="language-plaintext highlighter-rouge">.ini</code> file from earlier. Edit <code class="language-plaintext highlighter-rouge">roles/my-role/templates/test.ini.j2</code> and add the line <code class="language-plaintext highlighter-rouge">apikey = {{ apikey }}</code></p>
    </li>
    <li>
      <p>Add encrypted variable file to <code class="language-plaintext highlighter-rouge">playbook.yml</code></p>

      <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="pi">-</span> <span class="na">hosts</span><span class="pi">:</span> <span class="s">my_hosts</span>
  <span class="s">...</span>
  <span class="na">vars_files</span><span class="pi">:</span>
   <span class="pi">-</span> <span class="s">secret_group_vars/all.yml</span>
</code></pre></div>      </div>
    </li>
    <li>
      <p>Tell ansible where to find the decryption file. Create file <code class="language-plaintext highlighter-rouge">ansible.cfg</code> with content</p>

      <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="pi">[</span><span class="nv">defaults</span><span class="pi">]</span>
<span class="s">vault_password_file=vault-password.txt</span>
</code></pre></div>      </div>
    </li>
    <li>
      <p>Run the playbook</p>
    </li>
    <li>
      <p>Check the contents of <code class="language-plaintext highlighter-rouge">/tmp/test.ini</code></p>

      <blockquote class="code-2col">
        <blockquote class="code-in">
          <h3 id="code-in-input-bash-4"><i class="far fa-keyboard" aria-hidden="true"></i><span class="visually-hidden">code-in</span> Input: Bash</h3>
          <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cat</span> /tmp/test.ini
</code></pre></div>          </div>
        </blockquote>

        <blockquote class="code-out">
          <h3 id="code-out-output-3"><i class="fas fa-laptop-code" aria-hidden="true"></i><span class="visually-hidden">code-out</span> Output</h3>
          <p>The file should look like:</p>

          <div class="language-ini highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">[example]</span>
<span class="py">server_name</span> <span class="p">=</span> <span class="s">Dogs!</span>
<span class="py">listen</span> <span class="p">=</span> <span class="s">192.168.0.2</span>
<span class="py">apikey</span> <span class="p">=</span> <span class="s">super-secret-api-key-wow!</span>
</code></pre></div>          </div>
        </blockquote>
      </blockquote>
    </li>
  </ol>

</blockquote>

<p>In real life scenarios where you are sharing your playbooks publicly, be sure to encrypt all secrets from the start (or fix/remove the git history if you ever did.) If you are storing your vault password in a file, remember to add it to your <code class="language-plaintext highlighter-rouge">.gitignore</code> (or VCS appropriate file.)</p>

<h1 id="other-stuff">Other Stuff</h1>

<p>Ansible has a huge array of features and we can‚Äôt cover them all. Some commonly used features are documented below:</p>

<h2 id="with-items">With Items</h2>

<p>Duplicating tasks ten times to install ten packages is not efficient, so Ansible provides <code class="language-plaintext highlighter-rouge">loop</code> construct</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Install stuff</span>
  <span class="na">package</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">item</span><span class="nv"> </span><span class="s">}}"</span>
    <span class="na">state</span><span class="pi">:</span> <span class="s">installed</span>
  <span class="na">loop</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">htop</span>
    <span class="pi">-</span> <span class="s">git</span>
    <span class="pi">-</span> <span class="s">vim</span>
</code></pre></div></div>

<p>This works for any task, not just package installation, if you have things you‚Äôd like to repeat.
Note that for this task one would normally list multiple packages in the <code class="language-plaintext highlighter-rouge">name</code> parameter of the package module.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Install stuff</span>
  <span class="na">package</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">htop</span>
      <span class="pi">-</span> <span class="s">git</span>
      <span class="pi">-</span> <span class="s">vim</span>
    <span class="na">state</span><span class="pi">:</span> <span class="s">installed</span>
</code></pre></div></div>

<h2 id="when-changed">When Changed</h2>

<p>Doing something only when a task is in the ‚Äúchanged‚Äù state is a common pattern. This is often used for reloading a service when some configuration files have changed.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Copy configuration file</span>
  <span class="na">copy</span><span class="pi">:</span>
    <span class="na">src</span><span class="pi">:</span> <span class="s">main.conf</span>
    <span class="na">dest</span><span class="pi">:</span> <span class="s">/etc/service/main.conf</span>
    <span class="na">owner</span><span class="pi">:</span> <span class="s">root</span>
    <span class="na">group</span><span class="pi">:</span> <span class="s">root</span>
    <span class="na">mode</span><span class="pi">:</span> <span class="m">0644</span>
  <span class="na">register</span><span class="pi">:</span> <span class="s">service_conf</span>

<span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Restart the service</span>
  <span class="na">service</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">service</span>
    <span class="na">enabled</span><span class="pi">:</span> <span class="s">yes</span>
    <span class="na">state</span><span class="pi">:</span> <span class="s">restarted</span>
  <span class="na">when</span><span class="pi">:</span> <span class="s">service_conf is changed</span>
</code></pre></div></div>

<h2 id="notifying-handlers">Notifying Handlers</h2>

<p>Often you want to restart a service whenever something has changed, like above. But if you need to restart the service whenever one of many different tasks has changed, there is a simpler way than writing <code class="language-plaintext highlighter-rouge">when: a.changed or b.changed or c.changed or ...</code></p>

<p>First, move the restarting or reloading of the service into the <code class="language-plaintext highlighter-rouge">handlers/main.yml</code></p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">restart service</span>
  <span class="na">service</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">service</span>
    <span class="na">enabled</span><span class="pi">:</span> <span class="s">yes</span>
    <span class="na">state</span><span class="pi">:</span> <span class="s">restarted</span>

<span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">reload httpd</span>
  <span class="na">service</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">httpd</span>
    <span class="na">enabled</span><span class="pi">:</span> <span class="s">yes</span>
    <span class="na">state</span><span class="pi">:</span> <span class="s">reloaded</span>
</code></pre></div></div>

<p>Now you can change your task definitions:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Copy configuration file</span>
  <span class="na">copy</span><span class="pi">:</span>
    <span class="na">src</span><span class="pi">:</span> <span class="s">main.conf</span>
    <span class="na">dest</span><span class="pi">:</span> <span class="s2">"</span><span class="s">/etc/service/main.conf</span>
    <span class="s">owner:</span><span class="nv"> </span><span class="s">"root"</span>
    <span class="na">group</span><span class="pi">:</span> <span class="s2">"</span><span class="s">root"</span>
    <span class="na">mode</span><span class="pi">:</span> <span class="s2">"</span><span class="s">0644"</span>
  <span class="na">notify</span><span class="pi">:</span> <span class="s1">'</span><span class="s">restart</span><span class="nv"> </span><span class="s">service'</span>
</code></pre></div></div>

<p>We no longer <code class="language-plaintext highlighter-rouge">register</code> the command, instead the <code class="language-plaintext highlighter-rouge">notify</code> attribute automatically marks that the appropriate handler should be called <em>at the end of the playbook run</em>. Additionally, tasks from outside of this role can use the same <code class="language-plaintext highlighter-rouge">notify</code>. So if you use a community built role for managing apache, and then have a custom role that builds the apache configuration, you can use changes there to reload the service using their definition of the reload/restart.</p>


                
                <blockquote class="key_points">
                    <h3><i class="fas fa-key" aria-hidden="true"></i> Key points</h3>
                    <ul>
                        
                        <li><p>Ansible lets you do system administration at scale</p>
</li>
                        
                        <li><p>Many system administration, software installation, and software management tasks are already available as Ansible tasks or roles</p>
</li>
                        
                    </ul>
                </blockquote>
                

                <h1>Frequently Asked Questions</h1>
                Have questions about this tutorial? Check out the  <a href="/training-material/topics/admin/faqs/">FAQ page for the Galaxy Server administration topic</a> to see if your question is listed there.
                If not, please ask your question on the <a href="https://gitter.im/Galaxy-Training-Network/Lobby">GTN Gitter Channel</a> or the
                <a href="https://help.galaxyproject.org">Galaxy Help Forum</a>

                

                

                

                <h1>Feedback</h1>
                <p class="text-muted">Did you use this material as an instructor? Feel free to give us feedback on <a href="https://github.com/galaxyproject/training-material/issues/1452" target="_blank">how it went</a>.
                <br>Did you use this material as a learner or student? Click the form below to leave feedback.<i class="fas fa-hand-point-down"></i>
                </p>

                <div id="feedback-button">
                    <img src="/training-material/shared/images/feedback.png" title="Click to activate" alt="Click here to load Google feedback frame" />
                </div>
                <div id="feedback-form">
                </div>
                <script type="text/javascript">
                    (function (window, document) {
                        function onDocumentReady(fn) {
                            if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
                                fn();
                            } else {
                                document.addEventListener('DOMContentLoaded', fn);
                            }
                        }

                        onDocumentReady(function () {
                            $("#feedback-button").click(function(evt){
                                var e = $(evt.target)
                                e.hide();

                                $("#feedback-form").html(`
                                    <iframe id="feedback-google" class="google-form" src="https://docs.google.com/forms/d/e/1FAIpQLSd4VZptFTQ03kHkMz0JyW9b6_S8geU5KjNE_tLM0dixT3ZQmA/viewform?embedded=true&entry.1235803833=Ansible (Galaxy Server administration)">Loading...</iframe>
                                `)
                            })
                        });
                    })(window, document);
                </script>



                <h1>Citing this Tutorial</h1>
                <p>
                    <ol>
                        <li id="citation-text">Helena Rasche, Saskia Hiltemann, 2021 <b>Ansible (Galaxy Training Materials)</b>. <a href="https://training.galaxyproject.org/training-material/topics/admin/tutorials/ansible/tutorial.html">https://training.galaxyproject.org/training-material/topics/admin/tutorials/ansible/tutorial.html</a> Online; accessed TODAY
                        </li>
                        <li>
                        Batut et al., 2018 <b>Community-Driven Data Analysis Training for Biology</b> Cell Systems <a href="https://doi.org/10.1016%2Fj.cels.2018.05.012">10.1016/j.cels.2018.05.012</a>
                        </li>
                    </ol>
                </p>


                <blockquote class="details">
                  <h3><i class="fa fa-info-circle" aria-hidden="true"></i><span class="visually-hidden">details</span> BibTeX</h3>
                  <p style="display: none;">

                <div class="highlighter-rouge"><div class="highlight"><pre class="highlight">
<code id="citation-code">@misc{admin-ansible,
author = "Helena Rasche and Saskia Hiltemann",
title = "Ansible (Galaxy Training Materials)",
year = "2021",
month = "07",
day = "09"
url = "\url{https://training.galaxyproject.org/training-material/topics/admin/tutorials/ansible/tutorial.html}",
note = "[Online; accessed TODAY]"
}
@article{Batut_2018,
    doi = {10.1016/j.cels.2018.05.012},
    url = {https://doi.org/10.1016%2Fj.cels.2018.05.012},
    year = 2018,
    month = {jun},
    publisher = {Elsevier {BV}},
    volume = {6},
    number = {6},
    pages = {752--758.e1},
    author = {B{\'{e}}r{\'{e}}nice Batut and Saskia Hiltemann and Andrea Bagnacani and Dannon Baker and Vivek Bhardwaj and Clemens Blank and Anthony Bretaudeau and Loraine Brillet-Gu{\'{e}}guen and Martin {\v{C}}ech and John Chilton and Dave Clements and Olivia Doppelt-Azeroual and Anika Erxleben and Mallory Ann Freeberg and Simon Gladman and Youri Hoogstrate and Hans-Rudolf Hotz and Torsten Houwaart and Pratik Jagtap and Delphine Larivi{\`{e}}re and Gildas Le Corguill{\'{e}} and Thomas Manke and Fabien Mareuil and Fidel Ram{\'{\i}}rez and Devon Ryan and Florian Christoph Sigloch and Nicola Soranzo and Joachim Wolff and Pavankumar Videm and Markus Wolfien and Aisanjiang Wubuli and Dilmurat Yusuf and James Taylor and Rolf Backofen and Anton Nekrutenko and Bj√∂rn Gr√ºning},
    title = {Community-Driven Data Analysis Training for Biology},
    journal = {Cell Systems}
}</code>
                </pre></div></div>
                </p>
                </blockquote>


<script type="text/javascript">
// update the date on load, or leave fallback of 'today'
d = new Date();
document.getElementById("citation-code").innerHTML = document.getElementById("citation-code").innerHTML.replace("TODAY", d.toDateString());
document.getElementById("citation-text").innerHTML = document.getElementById("citation-text").innerHTML.replace("TODAY", d.toDateString());
</script>

                <h3><i class="far fa-thumbs-up" aria-hidden="true"></i> Congratulations on successfully completing this tutorial!</h3>

                

                

            </div>
        </div>
    </div>
</section>
<br/>
<br/>
<br/>

        </div>
        
    </body>
    <script type="text/javascript" src="/training-material/assets/js/jquery.slim.min.js"></script>
    <script type="text/javascript" src="/training-material/assets/js/popper.min.js"></script>
    <script type="text/javascript" src="/training-material/assets/js/bootstrap.min.js?v=3"></script>
    <script type="text/javascript" src="/training-material/assets/js/details-element-polyfill.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="/training-material/assets/js/bootstrap-toc.min.js"></script>
    <script type="text/javascript" src="/training-material/assets/js/main.js"></script>
    <script type="text/javascript" src="/training-material/assets/js/theme.js"></script>

    <script type="text/javascript" src="/training-material/assets/js/clipboard.min.js"></script>
    <script type="text/javascript">
    var snippets=document.querySelectorAll('div.highlight');
    [].forEach.call(snippets,function(snippet){
        snippet.firstChild.insertAdjacentHTML('beforebegin','<button class="btn btn-light" data-clipboard-snippet><i class="fa fa-copy"></i>&nbsp;Copy</button>');
    });

    var clipboardSnippets=new ClipboardJS('[data-clipboard-snippet]',{
        target:function(trigger){return trigger.nextElementSibling;
    }});
    </script>
    

    <script type="text/javascript">
        if(window.location.hostname === "galaxyproject.github.io") {
            // Redirect
            var redirect = "https://training.galaxyproject.org" + window.location.pathname + window.location.search;
            $('div.container.main-content').prepend("<div class='alert alert-warning'><strong>Note: </strong>This content has a new home at <a href=\"" + redirect + "\">" + redirect + "</a>, which you will be redirected to in 5 seconds.</div>");

            window.setTimeout(function(){
                window.location.href = redirect;
            }, 5000)

        }
    </script>
</html>
